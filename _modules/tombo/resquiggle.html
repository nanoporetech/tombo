

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tombo.resquiggle &mdash; Tombo 1.5.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Tombo
          

          
          </a>

          
            
            
              <div class="version">
                1.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tombo Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Tombo Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resquiggle.html">Re-squiggle Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modified_base_detection.html">Modified Base Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../text_output.html">Text Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filtering.html">Read Filtering Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rna.html">RNA Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_training.html">Model Training (Advanced Users Only)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tombo.html">tombo package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tombo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tombo.resquiggle</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tombo.resquiggle</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">zip</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="c1"># pip allows tombo install without correct version of mappy, so check here</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">mappy</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">mappy</span><span class="o">.</span><span class="n">Aligner</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">devnull</span><span class="p">)</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mappy</span><span class="o">.</span><span class="n">Aligner</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">devnull</span><span class="p">)</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Tombo requires mappy version &gt;= 2.10.&#39;</span><span class="p">)</span>

<span class="c1"># Future warning from cython in h5py</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">tqdm._utils</span> <span class="kn">import</span> <span class="n">_term_move_up</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_string</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1"># import tombo modules/functions</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tombo_stats</span> <span class="k">as</span> <span class="n">ts</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tombo_helper</span> <span class="k">as</span> <span class="n">th</span>

<span class="kn">from</span> <span class="nn">._default_parameters</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EXTRA_SIG_FACTOR</span><span class="p">,</span> <span class="n">MASK_FILL_Z_SCORE</span><span class="p">,</span>
    <span class="n">MASK_BASES</span><span class="p">,</span> <span class="n">DEL_FIX_WINDOW</span><span class="p">,</span> <span class="n">MAX_DEL_FIX_WINDOW</span><span class="p">,</span>
    <span class="n">MIN_EVENT_TO_SEQ_RATIO</span><span class="p">,</span> <span class="n">MAX_RAW_CPTS</span><span class="p">,</span> <span class="n">SHIFT_CHANGE_THRESH</span><span class="p">,</span>
    <span class="n">SCALE_CHANGE_THRESH</span><span class="p">,</span> <span class="n">SIG_MATCH_THRESH</span><span class="p">,</span> <span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="n">RNA_SAMP_TYPE</span><span class="p">,</span>
    <span class="n">USE_RNA_EVENT_SCALE</span><span class="p">,</span> <span class="n">RNA_SCALE_NUM_EVENTS</span><span class="p">,</span> <span class="n">RNA_SCALE_MAX_FRAC_EVENTS</span><span class="p">,</span>
    <span class="n">START_CLIP_PARAMS</span><span class="p">,</span> <span class="n">STALL_PARAMS</span><span class="p">,</span> <span class="n">COLLAPSE_RNA_STALLS</span><span class="p">,</span> <span class="n">COLLAPSE_DNA_STALLS</span><span class="p">)</span>
<span class="n">START_CLIP_PARAMS</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">startClipParams</span><span class="p">(</span><span class="o">*</span><span class="n">START_CLIP_PARAMS</span><span class="p">)</span>
<span class="n">DEFAULT_STALL_PARAMS</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">stallParams</span><span class="p">(</span><span class="o">**</span><span class="n">STALL_PARAMS</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">._c_dynamic_programming</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">c_reg_z_scores</span><span class="p">,</span> <span class="n">c_banded_forward_pass</span><span class="p">,</span> <span class="n">c_base_z_scores</span><span class="p">,</span>
    <span class="n">c_base_forward_pass</span><span class="p">,</span> <span class="n">c_base_traceback</span><span class="p">)</span>


<span class="c1"># list of classes/functions to include in API</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;get_read_seq&#39;</span><span class="p">,</span> <span class="s1">&#39;map_read&#39;</span><span class="p">,</span> <span class="s1">&#39;resquiggle_read&#39;</span><span class="p">,</span>
    <span class="s1">&#39;segment_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;find_adaptive_base_assignment&#39;</span><span class="p">,</span>
    <span class="s1">&#39;resolve_skipped_bases_with_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;find_seq_start_in_events&#39;</span><span class="p">,</span>
    <span class="s1">&#39;find_static_base_assignment&#39;</span><span class="p">]</span>


<span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">_PROFILE_RSQGL</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># use (mapping) clipped bases at the start of read to identify start position</span>
<span class="n">USE_START_CLIP_BASES</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># experimental RNA adapter trimming</span>
<span class="n">TRIM_RNA_ADAPTER</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># text output debugging</span>
<span class="n">_DEBUG_PARAMS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG_BANDWIDTH</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG_START_BANDWIDTH</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># plot output debugging</span>
<span class="n">_DEBUG_DP_ENDS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG_DP_START</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG_CLIP_START</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># fit debug plot requires r cowplot package to be installed</span>
<span class="n">_DEBUG_FIT</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG_START_CLIP_FIT</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># raw signal re-squiggle DP</span>
<span class="n">_DEBUG_RAW_DP</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># don&#39;t plot more than one debug type at a time</span>
<span class="k">assert</span> <span class="nb">sum</span><span class="p">((</span>
    <span class="n">_DEBUG_DP_ENDS</span><span class="p">,</span> <span class="n">_DEBUG_FIT</span><span class="p">,</span> <span class="n">_DEBUG_START_CLIP_FIT</span><span class="p">,</span>
    <span class="n">_DEBUG_DP_START</span><span class="p">,</span> <span class="n">_DEBUG_CLIP_START</span><span class="p">,</span> <span class="n">_DEBUG_RAW_DP</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span>
<span class="n">_DEBUG_PLOTTING</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span>
    <span class="n">_DEBUG_FIT</span><span class="p">,</span> <span class="n">_DEBUG_START_CLIP_FIT</span><span class="p">,</span> <span class="n">_DEBUG_DP_ENDS</span><span class="p">,</span> <span class="n">_DEBUG_DP_START</span><span class="p">,</span>
    <span class="n">_DEBUG_CLIP_START</span><span class="p">,</span> <span class="n">_DEBUG_RAW_DP</span><span class="p">))</span>
<span class="n">_DRY_RUN</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span>
    <span class="n">_DEBUG_PARAMS</span><span class="p">,</span> <span class="n">_DEBUG_BANDWIDTH</span><span class="p">,</span> <span class="n">_DEBUG_START_BANDWIDTH</span><span class="p">,</span> <span class="n">_DEBUG_PLOTTING</span><span class="p">))</span>

<span class="n">_UNEXPECTED_ERROR_FN</span> <span class="o">=</span> <span class="s1">&#39;unexpected_tombo_errors.</span><span class="si">{}</span><span class="s1">.err&#39;</span>
<span class="n">_MAX_NUM_UNEXP_ERRORS</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">_MAX_QUEUE_SIZE</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">_BROKEN_PIPE_ERR</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;Connection to re-squiggle process broken. THREAD CANNOT BE RECOVERED.&#39;</span><span class="p">)</span>


<span class="c1">##################################</span>
<span class="c1">########## Debug Output ##########</span>
<span class="c1">##################################</span>

<span class="k">def</span> <span class="nf">_write_params_debug</span><span class="p">(</span>
        <span class="n">norm_signal</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">read_id</span><span class="p">):</span>
    <span class="n">r_means</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">compute_base_means</span><span class="p">(</span><span class="n">norm_signal</span><span class="p">,</span> <span class="n">segs</span><span class="p">)</span>
    <span class="n">mean_half_z_score</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_read_seg_score</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">running_stat_width</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">min_obs_per_base</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">raw_min_obs_per_base</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">mean_obs_per_event</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">match_evalue</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">,</span> <span class="n">read_id</span><span class="p">,</span>
            <span class="n">mean_half_z_score</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_debug_plot_dp</span><span class="p">(</span>
        <span class="n">z_scores</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span>
        <span class="n">reg_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">debug_num_seq</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">reg_id</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">reg_id</span><span class="p">)</span>
    <span class="n">fwd_pass</span> <span class="o">=</span> <span class="n">fwd_pass</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">fwd_pass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">debug_num_seq</span><span class="p">:</span>
        <span class="n">debug_num_seq</span> <span class="o">=</span> <span class="n">fwd_pass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">debug_end_start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">band_event_starts</span><span class="p">)</span> <span class="o">-</span> <span class="n">debug_num_seq</span>

    <span class="n">event_poss</span><span class="p">,</span> <span class="n">seq_poss</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="p">(</span><span class="n">s_z_data</span><span class="p">,</span> <span class="n">s_f_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">z_scores</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">)):</span>
        <span class="n">b_e_start</span> <span class="o">=</span> <span class="n">band_event_starts</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">band_pos</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_z_data</span><span class="p">):</span>
            <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_pos</span> <span class="o">+</span> <span class="n">b_e_start</span><span class="p">)</span>
            <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">)</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span> <span class="o">+</span> <span class="s1">&#39;_z_begin&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">band_pos</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_f_data</span><span class="p">):</span>
            <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_pos</span> <span class="o">+</span> <span class="n">b_e_start</span><span class="p">)</span>
            <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">)</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span> <span class="o">+</span> <span class="s1">&#39;_fwd_begin&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq_pos</span> <span class="o">&gt;=</span> <span class="n">debug_num_seq</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">short</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="p">(</span><span class="n">s_z_data</span><span class="p">,</span> <span class="n">s_f_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">z_scores</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fwd_pass</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">end_seq_pos</span> <span class="o">=</span> <span class="n">debug_num_seq</span> <span class="o">-</span> <span class="n">seq_pos</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">b_e_start</span> <span class="o">=</span> <span class="n">band_event_starts</span><span class="p">[</span><span class="n">debug_end_start</span> <span class="o">+</span> <span class="n">end_seq_pos</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">band_pos</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_z_data</span><span class="p">):</span>
                <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_pos</span> <span class="o">+</span> <span class="n">b_e_start</span><span class="p">)</span>
                <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_seq_pos</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span> <span class="o">+</span> <span class="s1">&#39;_z_end&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">band_pos</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_f_data</span><span class="p">):</span>
                <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_pos</span> <span class="o">+</span> <span class="n">b_e_start</span><span class="p">)</span>
                <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_seq_pos</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span> <span class="o">+</span> <span class="s1">&#39;_fwd_end&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seq_pos</span> <span class="o">&gt;=</span> <span class="n">debug_num_seq</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="n">dpDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;EventPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">event_poss</span><span class="p">),</span>
        <span class="s1">&#39;SeqPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">),</span>
        <span class="s1">&#39;Score&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">regs</span><span class="p">)})</span>

    <span class="n">event_poss</span><span class="p">,</span> <span class="n">seq_poss</span><span class="p">,</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">read_tb</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">banded_traceback</span><span class="p">(</span><span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">read_tb</span><span class="p">[:</span><span class="n">debug_num_seq</span><span class="p">]):</span>
        <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_pos</span><span class="p">)</span>
        <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">)</span>
        <span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span> <span class="o">+</span> <span class="s1">&#39;_fwd_begin&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">short</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">read_tb</span><span class="p">[</span><span class="o">-</span><span class="n">debug_num_seq</span><span class="p">:]):</span>
            <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_pos</span><span class="p">)</span>
            <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">)</span>
            <span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_id</span> <span class="o">+</span> <span class="s1">&#39;_fwd_end&#39;</span><span class="p">)</span>

    <span class="n">tbDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;EventPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">event_poss</span><span class="p">),</span>
        <span class="s1">&#39;SeqPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">regs</span><span class="p">)})</span>

    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/debugDP.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotDP&#39;</span><span class="p">)](</span><span class="n">dpDat</span><span class="p">,</span> <span class="n">tbDat</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_debug_raw_dp</span><span class="p">(</span><span class="n">z_scores</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">read_tb</span><span class="p">,</span> <span class="n">sig_data</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">):</span>
    <span class="n">reg_id</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">reg_id</span><span class="p">)</span>

    <span class="n">event_poss</span><span class="p">,</span> <span class="n">seq_poss</span><span class="p">,</span> <span class="n">r_z_scores</span><span class="p">,</span> <span class="n">fwd_scores</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="p">((</span><span class="n">s_z_data</span><span class="p">,</span> <span class="p">(</span><span class="n">b_e_start</span><span class="p">,</span> <span class="n">b_e_end</span><span class="p">)),</span> <span class="n">s_f_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="n">z_scores</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fwd_pass</span><span class="p">))):</span>
        <span class="k">for</span> <span class="n">band_pos</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_z_data</span><span class="p">):</span>
            <span class="n">r_z_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_pos</span> <span class="o">+</span> <span class="n">b_e_start</span><span class="p">)</span>
            <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">band_pos</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_f_data</span><span class="p">):</span>
            <span class="n">fwd_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="n">zDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Score&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">),</span>
        <span class="s1">&#39;EventPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">event_poss</span><span class="p">),</span>
        <span class="s1">&#39;SeqPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">reg_id</span><span class="p">,]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">))})</span>
    <span class="n">fwdDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Score&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">fwd_scores</span><span class="p">),</span>
        <span class="s1">&#39;EventPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">event_poss</span><span class="p">),</span>
        <span class="s1">&#39;SeqPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">reg_id</span><span class="p">,]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">))})</span>

    <span class="n">event_poss</span><span class="p">,</span> <span class="n">seq_poss</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">read_tb</span><span class="p">):</span>
        <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">)</span>
        <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_pos</span><span class="p">)</span>
        <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">event_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">seq_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_tb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">tbDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;EventPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">event_poss</span><span class="p">),</span>
        <span class="s1">&#39;SeqPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">reg_id</span><span class="p">,]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_poss</span><span class="p">))})</span>

    <span class="n">sigDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Pos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sig_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))),</span>
        <span class="s1">&#39;Signal&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">sig_data</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/debugRawDP.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotRawDP&#39;</span><span class="p">)](</span><span class="n">zDat</span><span class="p">,</span> <span class="n">fwdDat</span><span class="p">,</span> <span class="n">tbDat</span><span class="p">,</span> <span class="n">sigDat</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_debug_fit</span><span class="p">(</span>
        <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span> <span class="n">z_scores</span><span class="p">,</span> <span class="n">reg_id</span><span class="p">,</span>
        <span class="n">final_score</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span>
        <span class="n">running_window</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">static_bw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">read_tb</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">banded_traceback</span><span class="p">(</span><span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">)</span>
    <span class="n">prev_event_pos</span> <span class="o">=</span> <span class="n">read_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">band_poss</span><span class="p">,</span> <span class="n">event_scores</span><span class="p">,</span> <span class="n">ref_means</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">read_tb</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">seq_band_poss</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_pos</span> <span class="o">-</span> <span class="n">band_event_starts</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">e_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">prev_event_pos</span><span class="p">,</span> <span class="n">event_pos</span><span class="p">)]</span>
        <span class="n">band_poss</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seq_band_poss</span><span class="p">)</span>
        <span class="n">event_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">z_scores</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">][</span><span class="n">b_pos</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">b_pos</span> <span class="ow">in</span> <span class="n">seq_band_poss</span><span class="p">])</span>
        <span class="n">ref_means</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r_ref_means</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">seq_band_poss</span><span class="p">])</span>
        <span class="n">prev_event_pos</span> <span class="o">=</span> <span class="n">event_pos</span>

    <span class="k">if</span> <span class="n">_DEBUG_BANDWIDTH</span> <span class="ow">or</span> <span class="n">_DEBUG_START_BANDWIDTH</span><span class="p">:</span>
        <span class="n">half_bandwidth</span> <span class="o">=</span> <span class="n">bandwidth</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">min_bw_edge_buffer</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">half_bandwidth</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">band_poss</span><span class="p">)</span> <span class="o">-</span> <span class="n">half_bandwidth</span><span class="p">))</span> <span class="k">if</span> <span class="n">_DEBUG_BANDWIDTH</span> <span class="k">else</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">band_poss</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="se">\t</span><span class="si">{:d}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">bandwidth</span><span class="p">,</span> <span class="n">min_bw_edge_buffer</span><span class="p">,</span> <span class="n">final_score</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_tb</span><span class="p">),</span> <span class="n">reg_id</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_DEBUG_FIT</span> <span class="ow">or</span> <span class="n">_DEBUG_START_CLIP_FIT</span><span class="p">):</span>
            <span class="k">return</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">running_window</span><span class="p">:</span>
        <span class="c1"># make sure window is odd</span>
        <span class="k">if</span> <span class="n">running_window</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">running_window</span> <span class="o">=+</span> <span class="mi">1</span>
        <span class="n">half_window</span> <span class="o">=</span> <span class="n">running_window</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">score_cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">event_scores</span><span class="p">)])</span>
        <span class="n">event_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">,</span> <span class="n">half_window</span><span class="p">),</span>
            <span class="p">(</span><span class="n">score_cumsum</span><span class="p">[:</span><span class="o">-</span><span class="n">running_window</span><span class="p">]</span> <span class="o">-</span> <span class="n">score_cumsum</span><span class="p">[</span><span class="n">running_window</span><span class="p">:])</span> <span class="o">/</span>
            <span class="n">running_window</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">,</span> <span class="n">half_window</span><span class="p">)])</span>

    <span class="n">reg_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">reg_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;__&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">final_score</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;__&#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">final_score</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_tb</span><span class="p">)))</span>

    <span class="n">fitDat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;EventPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_poss</span><span class="p">))),</span>
        <span class="s1">&#39;BandPos&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">IntVector</span><span class="p">(</span><span class="n">band_poss</span><span class="p">),</span>
        <span class="s1">&#39;EventMean&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">event_means</span><span class="p">[</span><span class="n">read_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">read_tb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
        <span class="s1">&#39;ModelMean&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">ref_means</span><span class="p">),</span>
        <span class="s1">&#39;EventScore&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">event_scores</span><span class="p">),</span>
        <span class="s1">&#39;Region&#39;</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">StrVector</span><span class="p">([</span><span class="n">reg_name</span><span class="p">,]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">band_poss</span><span class="p">))})</span>

    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="n">resource_string</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;R_scripts/debugFit.R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">globalenv</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;plotFit&#39;</span><span class="p">)](</span><span class="n">fitDat</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_open_debug_pdf</span><span class="p">():</span>
    <span class="c1"># import plotting modules</span>
    <span class="kn">from</span> <span class="nn">rpy2</span> <span class="kn">import</span> <span class="n">robjects</span> <span class="k">as</span> <span class="n">r</span>
    <span class="k">global</span> <span class="n">r</span>
    <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span>
    <span class="n">importr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;ggplot2&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">_DEBUG_DP_ENDS</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;debug_event_align.pdf&quot;, height=4.5, width=6)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">_DEBUG_CLIP_START</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;debug_event_align.clip_start.pdf&quot;, height=4.5, width=10)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">_DEBUG_DP_START</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;debug_event_align.start.pdf&quot;, height=4.5, width=10)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">_DEBUG_FIT</span><span class="p">:</span>
        <span class="n">importr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cowplot&#39;</span><span class="p">))</span>
        <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;debug_event_align.full_fit.pdf&quot;, width=15, height=5)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">_DEBUG_START_CLIP_FIT</span><span class="p">:</span>
        <span class="n">importr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cowplot&#39;</span><span class="p">))</span>
        <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;debug_event_align.start_clip_fit.pdf&quot;, width=15, height=5)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">_DEBUG_RAW_DP</span><span class="p">:</span>
        <span class="n">importr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cowplot&#39;</span><span class="p">))</span>
        <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;pdf(&quot;debug_event_align.raw_dp.pdf&quot;, width=11, height=7)&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Must specify which debug plot to open.&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_close_debug_pdf</span><span class="p">():</span>
    <span class="n">r</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;dev.off()&#39;</span><span class="p">)</span>
    <span class="k">return</span>


<span class="c1">############################################</span>
<span class="c1">########## Raw Signal Re-squiggle ##########</span>
<span class="c1">############################################</span>

<span class="k">def</span> <span class="nf">raw_forward_pass</span><span class="p">(</span><span class="n">reg_z_scores</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">):</span>
    <span class="c1"># dynamic programming algorithm to find modeled signal to base assignment</span>

    <span class="c1"># fill banded path with cumulative probabilties from the previous signal</span>
    <span class="c1"># either in the current base or the previous base (left or diagonal left</span>
    <span class="c1"># from associated plotting)</span>

    <span class="c1"># get the first row data</span>
    <span class="n">prev_b_data</span><span class="p">,</span> <span class="p">(</span><span class="n">prev_b_start</span><span class="p">,</span> <span class="n">prev_b_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg_z_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">prev_b_fwd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">prev_b_data</span><span class="p">)</span>
    <span class="c1"># store number of observations since last diagonal at each position</span>
    <span class="c1"># - forces forward pass to allow legal traceback paths while</span>
    <span class="c1">#   enforcing the minimum observations per base threshold</span>
    <span class="c1"># - should also help from optimization pushing poor fitting bases</span>
    <span class="c1">#   to assign only an observation or two</span>
    <span class="c1"># - will also use this data to traceback all reasonable paths</span>
    <span class="n">prev_b_last_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">prev_b_end</span> <span class="o">-</span> <span class="n">prev_b_start</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_obs_per_base</span>
    <span class="c1"># first row is just a cumsum since there is no previous row</span>
    <span class="n">reg_fwd_scores</span> <span class="o">=</span> <span class="p">[(</span><span class="n">prev_b_fwd_data</span><span class="p">,</span> <span class="n">prev_b_last_diag</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">prev_b_start</span><span class="p">,</span> <span class="n">prev_b_end</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">b_data</span><span class="p">,</span> <span class="p">(</span><span class="n">b_start</span><span class="p">,</span> <span class="n">b_end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reg_z_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">b_fwd_data</span><span class="p">,</span> <span class="n">prev_b_last_diag</span> <span class="o">=</span> <span class="n">c_base_forward_pass</span><span class="p">(</span>
            <span class="n">b_data</span><span class="p">,</span> <span class="n">b_start</span><span class="p">,</span> <span class="n">b_end</span><span class="p">,</span>
            <span class="n">prev_b_data</span><span class="p">,</span> <span class="n">prev_b_start</span><span class="p">,</span> <span class="n">prev_b_end</span><span class="p">,</span>
            <span class="n">prev_b_fwd_data</span><span class="p">,</span> <span class="n">prev_b_last_diag</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">)</span>

        <span class="c1"># consider storing data to form traceback in one go at the</span>
        <span class="c1"># end of this loop</span>
        <span class="n">reg_fwd_scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="n">b_fwd_data</span><span class="p">,</span> <span class="n">prev_b_last_diag</span><span class="p">,</span> <span class="p">(</span><span class="n">b_start</span><span class="p">,</span> <span class="n">b_end</span><span class="p">)))</span>
        <span class="n">prev_b_data</span><span class="p">,</span> <span class="n">prev_b_fwd_data</span><span class="p">,</span> <span class="n">prev_b_start</span><span class="p">,</span> <span class="n">prev_b_end</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">b_data</span><span class="p">,</span> <span class="n">b_fwd_data</span><span class="p">,</span> <span class="n">b_start</span><span class="p">,</span> <span class="n">b_end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reg_fwd_scores</span>

<span class="k">def</span> <span class="nf">raw_traceback</span><span class="p">(</span><span class="n">reg_fwd_scores</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">):</span>
    <span class="c1"># traceback along maximally likely path</span>

    <span class="c1"># initilize array to store new segments</span>
    <span class="n">new_segs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_fwd_scores</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="c1"># get first two bases of data for lookups</span>
    <span class="n">curr_b_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg_fwd_scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">next_b_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg_fwd_scores</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">new_segs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_base_traceback</span><span class="p">(</span>
        <span class="n">curr_b_data</span><span class="p">,</span> <span class="n">curr_start</span><span class="p">,</span> <span class="n">next_b_data</span><span class="p">,</span> <span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">,</span>
        <span class="n">curr_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">base_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_fwd_scores</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">curr_b_data</span><span class="p">,</span> <span class="n">curr_start</span> <span class="o">=</span> <span class="n">next_b_data</span><span class="p">,</span> <span class="n">next_start</span>
        <span class="n">next_b_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg_fwd_scores</span><span class="p">[</span><span class="n">base_pos</span><span class="p">]</span>
        <span class="n">new_segs</span><span class="p">[</span><span class="n">base_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_base_traceback</span><span class="p">(</span>
            <span class="n">curr_b_data</span><span class="p">,</span> <span class="n">curr_start</span><span class="p">,</span> <span class="n">next_b_data</span><span class="p">,</span> <span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">,</span>
            <span class="n">new_segs</span><span class="p">[</span><span class="n">base_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_segs</span>

<div class="viewcode-block" id="resolve_skipped_bases_with_raw"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.resolve_skipped_bases_with_raw">[docs]</a><span class="k">def</span> <span class="nf">resolve_skipped_bases_with_raw</span><span class="p">(</span>
        <span class="n">dp_res</span><span class="p">,</span> <span class="n">norm_signal</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span>
        <span class="n">max_raw_cpts</span><span class="o">=</span><span class="n">MAX_RAW_CPTS</span><span class="p">,</span> <span class="n">del_fix_window</span><span class="o">=</span><span class="n">DEL_FIX_WINDOW</span><span class="p">,</span>
        <span class="n">max_del_fix_window</span><span class="o">=</span><span class="n">MAX_DEL_FIX_WINDOW</span><span class="p">,</span>
        <span class="n">extra_sig_factor</span><span class="o">=</span><span class="n">EXTRA_SIG_FACTOR</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform dynamic-programming forward pass over raw signal z-scores. For details, see https://nanoporetech.github.io/tombo/resquiggle.html#resolve-skipped-bases</span>

<span class="sd">    Args:</span>
<span class="sd">        dp_res (:class:`tombo_helper.dpResults`): dynamic programming results</span>
<span class="sd">        norm_signal (`np.array::np.float64`): normalized raw siganl</span>
<span class="sd">        rsqgl_params (:class:`tombo.tombo_helper.resquiggleParams`): parameters for the re-squiggle algorithm</span>
<span class="sd">        max_raw_cpts (int): maximum new changepoints to find from raw signal (optional)</span>
<span class="sd">        del_fix_window (int): initial bases to extend skipped base windows (optional)</span>
<span class="sd">        max_del_fix_window (int): max bases to extend skipped base windows (optional)</span>
<span class="sd">        extra_sig_factor (float): amount of extra signal required to perform signal space re-squiggle (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``np.array::np.int64`` containing new deletion resolved base raw signal start positions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">merge_del_windows</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">):</span>
        <span class="n">merged_del_windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">all_del_windows</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_del_windows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="n">start</span> <span class="o">&lt;</span> <span class="n">merged_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">merged_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">merged_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged_del_windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">merged_del_windows</span>

    <span class="k">def</span> <span class="nf">window_too_small</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">sig_start</span><span class="p">,</span> <span class="n">sig_end</span> <span class="o">=</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[</span><span class="n">end</span><span class="p">]</span>
        <span class="n">sig_len</span> <span class="o">=</span> <span class="n">sig_end</span> <span class="o">-</span> <span class="n">sig_start</span>
        <span class="c1"># windows are expanded by one base and the extra signal factor</span>
        <span class="c1"># to allow some room to search for best path</span>
        <span class="k">return</span> <span class="n">sig_len</span> <span class="o">&lt;=</span> <span class="p">((</span><span class="n">n_events</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
                           <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">raw_min_obs_per_base</span><span class="p">)</span> <span class="o">*</span> <span class="n">extra_sig_factor</span>

    <span class="k">def</span> <span class="nf">expand_small_windows</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">):</span>
        <span class="n">expanded_del_windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">windows_expanded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">all_del_windows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">window_too_small</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
                <span class="n">windows_expanded</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">start</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">expanded_del_windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">expanded_del_windows</span><span class="p">,</span> <span class="n">windows_expanded</span>

    <span class="k">def</span> <span class="nf">trim_del_window_ends</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">):</span>
        <span class="c1"># potentially trim first and last windows</span>
        <span class="k">if</span> <span class="n">all_del_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">all_del_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">all_del_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">all_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">all_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_del_windows</span>

    <span class="k">def</span> <span class="nf">get_deletion_windows</span><span class="p">():</span>
        <span class="c1"># get initial windows around deletions/skipped bases</span>
        <span class="n">all_del_windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">del_pos</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="n">del_pos</span> <span class="o">&lt;</span> <span class="n">all_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">del_fix_window</span><span class="p">):</span>
                <span class="n">all_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_del_windows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">del_pos</span> <span class="o">+</span> <span class="n">del_fix_window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_del_windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">del_pos</span> <span class="o">-</span> <span class="n">del_fix_window</span><span class="p">,</span>
                                        <span class="n">del_pos</span> <span class="o">+</span> <span class="n">del_fix_window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">windows_expanded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">all_del_windows</span> <span class="o">=</span> <span class="n">merge_del_windows</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">)</span>
        <span class="n">all_del_windows</span> <span class="o">=</span> <span class="n">trim_del_window_ends</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">)</span>
        <span class="c1"># expand small windows until there are no more or the max del window</span>
        <span class="c1"># expansions have been attempted.</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_del_fix_window</span> <span class="o">-</span> <span class="n">del_fix_window</span><span class="p">):</span>
            <span class="n">all_del_windows</span><span class="p">,</span> <span class="n">windows_expanded</span> <span class="o">=</span> <span class="n">expand_small_windows</span><span class="p">(</span>
                <span class="n">all_del_windows</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">windows_expanded</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">all_del_windows</span> <span class="o">=</span> <span class="n">merge_del_windows</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">)</span>
            <span class="n">all_del_windows</span> <span class="o">=</span> <span class="n">trim_del_window_ends</span><span class="p">(</span><span class="n">all_del_windows</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">windows_expanded</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">window_too_small</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">all_del_windows</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;Not enough raw signal around potential genomic deletion(s)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_raw_cpts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">([</span>
                <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">all_del_windows</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_raw_cpts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;Read contains too many potential genomic deletions&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_del_windows</span>


    <span class="n">all_del_windows</span> <span class="o">=</span> <span class="n">get_deletion_windows</span><span class="p">()</span>
    <span class="n">resolved_segs</span> <span class="o">=</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">all_del_windows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resolved_segs</span>

    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">all_del_windows</span><span class="p">:</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">sig_start</span><span class="p">,</span> <span class="n">sig_end</span> <span class="o">=</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[</span><span class="n">end</span><span class="p">]</span>
        <span class="n">sig_len</span> <span class="o">=</span> <span class="n">sig_end</span> <span class="o">-</span> <span class="n">sig_start</span>

        <span class="c1"># find signal space z-scores mapping without real banding by allowing</span>
        <span class="c1"># entire window to be searched (c_reg_z_scores will clip base search</span>
        <span class="c1"># windows to enforce min_obs_per_base)</span>
        <span class="n">pseudo_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sig_len</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">reg_z_scores</span> <span class="o">=</span> <span class="n">c_reg_z_scores</span><span class="p">(</span>
            <span class="n">norm_signal</span><span class="p">[</span><span class="n">sig_start</span><span class="p">:</span><span class="n">sig_end</span><span class="p">],</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">ref_means</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span>
            <span class="n">dp_res</span><span class="o">.</span><span class="n">ref_sds</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">pseudo_starts</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">n_events</span><span class="p">,</span> <span class="n">n_events</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">raw_min_obs_per_base</span><span class="p">,</span>
            <span class="n">max_half_z_score</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">)</span>
        <span class="n">reg_fwd_scores</span> <span class="o">=</span> <span class="n">raw_forward_pass</span><span class="p">(</span>
            <span class="n">reg_z_scores</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">raw_min_obs_per_base</span><span class="p">)</span>
        <span class="c1"># perform signal based scoring segmentation</span>
        <span class="c1">#  - it is ~60X faster than base space</span>
        <span class="n">reg_segs</span> <span class="o">=</span> <span class="n">raw_traceback</span><span class="p">(</span>
            <span class="n">reg_fwd_scores</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">raw_min_obs_per_base</span><span class="p">)</span> <span class="o">+</span> <span class="n">sig_start</span>
        <span class="k">if</span> <span class="n">_DEBUG_RAW_DP</span><span class="p">:</span>
            <span class="n">_debug_raw_dp</span><span class="p">(</span><span class="n">reg_z_scores</span><span class="p">,</span> <span class="n">reg_fwd_scores</span><span class="p">,</span> <span class="n">reg_segs</span> <span class="o">-</span> <span class="n">sig_start</span><span class="p">,</span>
            <span class="n">norm_signal</span><span class="p">[</span><span class="n">sig_start</span><span class="p">:</span><span class="n">sig_end</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">reg_segs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Invalid segmentation results.&#39;</span><span class="p">)</span>
        <span class="n">resolved_segs</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_segs</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">resolved_segs</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;New segments include zero length events&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resolved_segs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;New segments start with negative index&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resolved_segs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">norm_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;New segments end past raw signal values&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">resolved_segs</span></div>


<span class="c1">#####################################################</span>
<span class="c1">########## Static Band Dynamic Programming ##########</span>
<span class="c1">#####################################################</span>

<div class="viewcode-block" id="find_static_base_assignment"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.find_static_base_assignment">[docs]</a><span class="k">def</span> <span class="nf">find_static_base_assignment</span><span class="p">(</span>
        <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span>
        <span class="n">reg_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Align expected (from genome sequence) signal levels to observed using a dynamic programming approach with static bandwidth start positions</span>

<span class="sd">    Args:</span>
<span class="sd">        event_means (`np.array::np.float64`): read base means</span>
<span class="sd">        r_ref_means (`np.array::np.float64`): expected base signal levels</span>
<span class="sd">        r_ref_sds (`np.array::np.float64`): expected base level SDs</span>
<span class="sd">        rsqgl_params (:class:`tombo.tombo_helper.resquiggleParams`): parameters for the re-squiggle algorithm</span>

<span class="sd">    Returns:</span>
<span class="sd">        `np.array::np.int64` containng event to sequence mapping for full length of short read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">r_ref_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">events_len</span> <span class="o">=</span> <span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># create read starts in order to clip just the corners of the full events to</span>
    <span class="c1"># seqeunce matrix</span>
    <span class="n">mask_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">events_len</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">band_event_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span> <span class="o">-</span> <span class="n">mask_len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">,</span> <span class="n">mask_len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">events_len</span> <span class="o">-</span> <span class="n">mask_len</span>

    <span class="n">shifted_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">band_event_starts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bandwidth</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_event_starts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shifted_z_scores</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">event_means</span><span class="p">[</span><span class="n">event_pos</span><span class="p">:</span><span class="n">event_pos</span> <span class="o">+</span> <span class="n">bandwidth</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">r_ref_means</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">])</span> <span class="o">/</span> <span class="n">r_ref_sds</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shifted_z_scores</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">event_means</span><span class="p">[</span><span class="n">event_pos</span><span class="p">:</span><span class="n">event_pos</span> <span class="o">+</span> <span class="n">bandwidth</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">r_ref_means</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">])</span> <span class="o">/</span> <span class="n">r_ref_sds</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">])</span>

    <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span> <span class="o">=</span> <span class="n">c_banded_forward_pass</span><span class="p">(</span>
        <span class="n">shifted_z_scores</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">stay_pen</span><span class="p">)</span>

    <span class="c1"># perform traceback</span>
    <span class="n">top_max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
    <span class="k">if</span> <span class="n">_DEBUG_FIT</span><span class="p">:</span>
        <span class="n">_debug_fit</span><span class="p">(</span><span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span>
                   <span class="n">shifted_z_scores</span><span class="p">,</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">top_max_pos</span><span class="p">],</span>
                   <span class="n">bandwidth</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">static_bw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_DEBUG_DP_ENDS</span><span class="p">:</span>
        <span class="n">_debug_plot_dp</span><span class="p">(</span><span class="n">shifted_z_scores</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span>
                       <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">read_tb</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">banded_traceback</span><span class="p">(</span><span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">read_tb</span></div>


<span class="c1">#######################################################</span>
<span class="c1">########## Adaptive Band Dynamic Programming ##########</span>
<span class="c1">#######################################################</span>

<span class="k">def</span> <span class="nf">_get_masked_start_fwd_pass</span><span class="p">(</span>
        <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">mapped_start_offset</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">events_per_base</span><span class="p">,</span> <span class="n">mask_fill_z_score</span><span class="o">=</span><span class="n">MASK_FILL_Z_SCORE</span><span class="p">,</span>
        <span class="n">mask_bases</span><span class="o">=</span><span class="n">MASK_BASES</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mapped_start_offset</span> <span class="o">&lt;</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Read sequence to signal matching starts too far into events for &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;full adaptive assignment&#39;</span><span class="p">)</span>
    <span class="c1"># if max_half_z_score is none set it to valid float for cython</span>
    <span class="c1"># z-score computation</span>
    <span class="k">if</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">do_winsorize_z</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rsqgl_params</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">max_half_z_score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">do_winsorize_z</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">half_bandwidth</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># check if the mapped start position is too close to the end of</span>
    <span class="c1"># the events array and extend the bandwidth window if so</span>
    <span class="n">band_events_start_pos</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">0</span> <span class="k">if</span> <span class="n">half_bandwidth</span> <span class="o">&lt;=</span> <span class="n">mapped_start_offset</span> <span class="k">else</span>
        <span class="n">mapped_start_offset</span> <span class="o">-</span> <span class="n">half_bandwidth</span><span class="p">)</span>

    <span class="n">tmp_seq_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">half_bandwidth</span><span class="p">,</span> <span class="n">mask_bases</span><span class="p">,</span>
                      <span class="nb">int</span><span class="p">((</span><span class="n">half_bandwidth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">events_per_base</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">band_event_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">band_events_start_pos</span><span class="p">,</span>
        <span class="n">band_events_start_pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp_seq_len</span> <span class="o">*</span> <span class="n">events_per_base</span><span class="p">),</span>
        <span class="n">tmp_seq_len</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">mask_seq_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">mask_bases</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_event_starts</span><span class="p">)</span>
                         <span class="k">if</span> <span class="n">bes</span> <span class="o">&gt;=</span> <span class="n">mapped_start_offset</span><span class="p">))</span>
    <span class="n">band_event_starts</span> <span class="o">=</span> <span class="n">band_event_starts</span><span class="p">[:</span><span class="n">mask_seq_len</span><span class="p">]</span>

    <span class="c1"># get masked z-scores at the beginning of the read</span>
    <span class="n">mask_start_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">mapped_start_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">band_event_starts</span><span class="p">[</span><span class="n">mask_bases</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">,</span>
        <span class="n">mask_bases</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_start_mask_z_score</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span><span class="p">):</span>
        <span class="n">start_mask_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mapped_start_offset</span> <span class="o">-</span> <span class="n">event_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">end_mask_len</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="k">if</span> <span class="n">seq_pos</span> <span class="o">&gt;=</span> <span class="n">mask_bases</span> <span class="k">else</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">-</span> <span class="p">(</span><span class="n">mask_start_pos</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">]</span> <span class="o">-</span> <span class="n">event_pos</span><span class="p">))</span>
        <span class="c1"># if the end mask does not clip back to the end of the events table</span>
        <span class="c1"># then extend the end mask to do so</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">event_pos</span> <span class="o">+</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">-</span> <span class="n">end_mask_len</span> <span class="o">&gt;</span>
            <span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">end_mask_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">event_pos</span> <span class="o">+</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">-</span>
                            <span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">event_vals</span> <span class="o">=</span> <span class="n">event_means</span><span class="p">[</span>
            <span class="n">event_pos</span> <span class="o">+</span> <span class="n">start_mask_len</span><span class="p">:</span>
            <span class="n">event_pos</span> <span class="o">+</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">-</span> <span class="n">end_mask_len</span><span class="p">]</span>
        <span class="n">b_z_scores</span> <span class="o">=</span> <span class="n">c_base_z_scores</span><span class="p">(</span>
            <span class="n">event_vals</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">],</span> <span class="n">r_ref_sds</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">],</span>
            <span class="n">do_winsorize_z</span><span class="o">=</span><span class="n">do_winsorize_z</span><span class="p">,</span>
            <span class="n">max_half_z_score</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">)</span>
        <span class="n">masked_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="p">[</span><span class="n">mask_fill_z_score</span> <span class="o">-</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span><span class="p">]</span> <span class="o">*</span>
            <span class="n">start_mask_len</span><span class="p">,</span> <span class="n">b_z_scores</span><span class="p">,</span>
            <span class="p">[</span><span class="n">mask_fill_z_score</span> <span class="o">-</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span><span class="p">]</span> <span class="o">*</span> <span class="n">end_mask_len</span><span class="p">])</span>
        <span class="c1"># This should have been handled above by checking the end_clip_len,</span>
        <span class="c1"># but raise an error here in case</span>
        <span class="k">if</span> <span class="n">masked_z_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Masked z-score contains too few events.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">masked_z_scores</span>
    <span class="n">shifted_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">band_event_starts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_event_starts</span><span class="p">):</span>
        <span class="n">shifted_z_scores</span><span class="p">[</span><span class="n">seq_pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">get_start_mask_z_score</span><span class="p">(</span><span class="n">seq_pos</span><span class="p">,</span> <span class="n">event_pos</span><span class="p">)</span>
    <span class="n">shifted_z_scores</span> <span class="o">+=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span>
    <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span> <span class="o">=</span> <span class="n">c_banded_forward_pass</span><span class="p">(</span>
        <span class="n">shifted_z_scores</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">stay_pen</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">shifted_z_scores</span>

<div class="viewcode-block" id="find_seq_start_in_events"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.find_seq_start_in_events">[docs]</a><span class="k">def</span> <span class="nf">find_seq_start_in_events</span><span class="p">(</span>
        <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span>
        <span class="n">num_bases</span><span class="p">,</span> <span class="n">num_events</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify most probably start of expected levels within observed events</span>

<span class="sd">    Args:</span>
<span class="sd">        event_means (`np.array::np.float64`): event normalized raw signal means</span>
<span class="sd">        r_ref_means (`np.array::np.float64`): expected base signal levels</span>
<span class="sd">        r_ref_sds (`np.array::np.float64`): expected base level SDs</span>
<span class="sd">        rsqgl_params (:class:`tombo.tombo_helper.resquiggleParams`): parameters for the re-squiggle algorithm</span>
<span class="sd">        num_bases (int): number of bases to process</span>
<span class="sd">        num_events (int): number of events to process</span>
<span class="sd">        reg_id (str): debug</span>

<span class="sd">    Returns:</span>
<span class="sd">        1) event position (0-based) corresponding to the start of expected signal levels</span>
<span class="sd">        2) mean events per base identified from start of the read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">num_events</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Read too short for start/end discovery&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r_ref_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">num_bases</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Genomic mapping too short for start/end discovery&#39;</span><span class="p">)</span>

    <span class="c1"># banded z-scores (moving up one event per base for start/end discovery</span>
    <span class="n">start_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">num_events</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">seq_event_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bases</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_z_scores</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">event_means</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">:</span><span class="n">seq_event_pos</span> <span class="o">+</span> <span class="n">num_events</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">r_ref_means</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">])</span> <span class="o">/</span> <span class="n">r_ref_sds</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_z_scores</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">event_means</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">:</span><span class="n">seq_event_pos</span> <span class="o">+</span> <span class="n">num_events</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">r_ref_means</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">])</span> <span class="o">/</span> <span class="n">r_ref_sds</span><span class="p">[</span><span class="n">seq_event_pos</span><span class="p">])</span>
    <span class="n">start_band_event_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="n">start_fwd_pass</span><span class="p">,</span> <span class="n">start_fwd_pass_move</span> <span class="o">=</span> <span class="n">c_banded_forward_pass</span><span class="p">(</span>
        <span class="n">start_z_scores</span><span class="p">,</span> <span class="n">start_band_event_starts</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">stay_pen</span><span class="p">)</span>

    <span class="c1"># find max along the top and right edges to start traceback</span>
    <span class="n">top_max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">start_fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
    <span class="k">if</span> <span class="n">_DEBUG_DP_START</span><span class="p">:</span>
        <span class="n">_debug_plot_dp</span><span class="p">(</span>
            <span class="n">start_z_scores</span><span class="p">,</span> <span class="n">start_fwd_pass</span><span class="p">,</span> <span class="n">start_band_event_starts</span><span class="p">,</span>
            <span class="n">start_fwd_pass_move</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="n">reg_id</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_DEBUG_START_BANDWIDTH</span><span class="p">:</span>
        <span class="n">_debug_fit</span><span class="p">(</span>
            <span class="n">start_fwd_pass_move</span><span class="p">,</span> <span class="n">start_band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span>
            <span class="n">start_z_scores</span><span class="p">,</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">start_fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">],</span>
            <span class="n">num_events</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">)</span>

    <span class="c1"># perform traceback</span>
    <span class="n">start_tb</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">banded_traceback</span><span class="p">(</span>
        <span class="n">start_fwd_pass_move</span><span class="p">,</span> <span class="n">start_band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">score_valid_bases</span><span class="p">(</span><span class="n">start_tb</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">)</span> <span class="o">&gt;</span>
        <span class="n">SIG_MATCH_THRESH</span><span class="p">[</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Poor raw to expected signal matching in beginning of read.&#39;</span><span class="p">)</span>

    <span class="c1"># compute the average events per base to use for the start forward pass</span>
    <span class="n">events_per_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_tb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_tb</span><span class="p">)</span>
    <span class="n">start_loc</span> <span class="o">=</span> <span class="n">start_tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">start_loc</span><span class="p">,</span> <span class="n">events_per_base</span></div>

<span class="k">def</span> <span class="nf">_trim_traceback</span><span class="p">(</span><span class="n">read_tb</span><span class="p">,</span> <span class="n">events_len</span><span class="p">):</span>
    <span class="n">start_trim_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">read_tb</span><span class="p">[</span><span class="n">start_trim_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">read_tb</span><span class="p">[</span><span class="n">start_trim_i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_trim_i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">end_trim_i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">read_tb</span><span class="p">[</span><span class="o">-</span><span class="n">end_trim_i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">events_len</span><span class="p">:</span>
        <span class="n">read_tb</span><span class="p">[</span><span class="o">-</span><span class="n">end_trim_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">events_len</span>
        <span class="n">end_trim_i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">read_tb</span>

<span class="k">def</span> <span class="nf">find_seq_start_from_clip_basecalls</span><span class="p">(</span>
        <span class="n">event_means</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">start_clip_bases</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
        <span class="n">num_genome_bases</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform dynamic programming over clipped basecalls and genome sequence to identify the start of the genomic mapping</span>

<span class="sd">    Args:</span>
<span class="sd">        event_means (`np.array::np.float64`): normalized raw signal event means</span>
<span class="sd">        rsqgl_params (:class:`tombo.tombo_helper.resquiggleParams`): parameters for the re-squiggle algorithm</span>
<span class="sd">        start_clip_bases (str): read bases clipped from before ``genome_seq``</span>
<span class="sd">        genome_seq (str): genomic mapping sequence (inlcuding extra bases based on k-mer size)</span>
<span class="sd">        std_ref (:class:`tombo.tombo_stats.TomboModel`): canonical model</span>
<span class="sd">        num_genome_bases (int): genome sequence length used to identify start position (needed for traceback)</span>
<span class="sd">        reg_id (str): debug</span>

<span class="sd">    Returns:</span>
<span class="sd">        1) event position (0-based) corresponding to the start of expected signal levels from genome_seq</span>
<span class="sd">        2) mean events per base identified from start of the read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">start_genome_seq</span> <span class="o">=</span> <span class="n">genome_seq</span><span class="p">[</span>
        <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">:</span><span class="n">num_genome_bases</span> <span class="o">+</span> <span class="n">dnstrm_bases</span><span class="p">]</span>
    <span class="n">start_seq</span> <span class="o">=</span> <span class="n">start_clip_bases</span> <span class="o">+</span> <span class="n">start_genome_seq</span>
    <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">get_exp_levels_from_seq</span><span class="p">(</span><span class="n">start_seq</span><span class="p">)</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">r_ref_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># now find full sequence to events path using a smaller bandwidth</span>
    <span class="p">(</span><span class="n">start_fwd_pass</span><span class="p">,</span> <span class="n">start_fwd_pass_move</span><span class="p">,</span>
     <span class="n">start_event_starts</span><span class="p">,</span> <span class="n">start_z_scores</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_masked_start_fwd_pass</span><span class="p">(</span>
         <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">rsqgl_params</span><span class="p">,</span> <span class="p">(</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">MASK_BASES</span><span class="p">))</span>
    <span class="n">start_seq_len</span> <span class="o">=</span> <span class="n">start_event_starts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fwd_pass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">fwd_pass</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_fwd_pass</span>
    <span class="n">fwd_pass_move</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">fwd_pass_move</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_fwd_pass_move</span>
    <span class="n">band_event_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">seq_len</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">band_event_starts</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_event_starts</span>

    <span class="k">if</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">do_winsorize_z</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rsqgl_params</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">max_half_z_score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">do_winsorize_z</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">_DEBUG_CLIP_START</span> <span class="ow">or</span> <span class="n">_DEBUG_START_CLIP_FIT</span><span class="p">:</span>
        <span class="c1"># save z-scores for debug plotting</span>
        <span class="n">rest_z_scores</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">adaptive_banded_forward_pass</span><span class="p">(</span>
            <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span>
            <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span>
            <span class="n">z_shift</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span><span class="p">,</span>
            <span class="n">skip_pen</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span> <span class="n">stay_pen</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">stay_pen</span><span class="p">,</span>
            <span class="n">start_seq_pos</span><span class="o">=</span><span class="n">start_seq_len</span><span class="p">,</span> <span class="n">mask_fill_z_score</span><span class="o">=</span><span class="n">MASK_FILL_Z_SCORE</span><span class="p">,</span>
            <span class="n">do_winsorize_z</span><span class="o">=</span><span class="n">do_winsorize_z</span><span class="p">,</span>
            <span class="n">max_half_z_score</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">,</span> <span class="n">return_z_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shifted_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span>
            <span class="n">seq_len</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">shifted_z_scores</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_z_scores</span>
        <span class="n">shifted_z_scores</span><span class="p">[</span><span class="n">start_seq_len</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rest_z_scores</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">adaptive_banded_forward_pass</span><span class="p">(</span>
            <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span>
            <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span>
            <span class="n">z_shift</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span><span class="p">,</span>
            <span class="n">skip_pen</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span> <span class="n">stay_pen</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">stay_pen</span><span class="p">,</span>
            <span class="n">start_seq_pos</span><span class="o">=</span><span class="n">start_seq_len</span><span class="p">,</span> <span class="n">mask_fill_z_score</span><span class="o">=</span><span class="n">MASK_FILL_Z_SCORE</span><span class="p">,</span>
            <span class="n">do_winsorize_z</span><span class="o">=</span><span class="n">do_winsorize_z</span><span class="p">,</span>
            <span class="n">max_half_z_score</span><span class="o">=</span><span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">)</span>

    <span class="n">top_max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
    <span class="k">if</span> <span class="n">_DEBUG_CLIP_START</span><span class="p">:</span>
        <span class="n">_debug_plot_dp</span><span class="p">(</span><span class="n">shifted_z_scores</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span>
                       <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="n">reg_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_DEBUG_START_CLIP_FIT</span><span class="p">:</span>
        <span class="n">_debug_fit</span><span class="p">(</span><span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span>
                   <span class="n">shifted_z_scores</span><span class="p">,</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">top_max_pos</span><span class="p">],</span>
                   <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">)</span>

    <span class="n">read_tb</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">banded_traceback</span><span class="p">(</span>
        <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">band_bound_thresh</span><span class="p">)</span>
    <span class="c1"># trim invalid traceback positions</span>
    <span class="n">read_tb</span> <span class="o">=</span> <span class="n">_trim_traceback</span><span class="p">(</span><span class="n">read_tb</span><span class="p">,</span> <span class="n">events_len</span><span class="o">=</span><span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_clip_bases</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">,</span> <span class="p">(</span>
        <span class="s1">&#39;Invalid start clip base processing.&#39;</span><span class="p">)</span>
    <span class="n">start_loc</span> <span class="o">=</span> <span class="n">read_tb</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">start_clip_bases</span><span class="p">)</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">]</span>
    <span class="n">events_per_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_tb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">start_genome_seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">dnstrm_bases</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">start_loc</span><span class="p">,</span> <span class="n">events_per_base</span>

<span class="k">def</span> <span class="nf">get_rel_raw_coords</span><span class="p">(</span><span class="n">valid_cpts</span><span class="p">,</span> <span class="n">seq_events</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get raw coordinates relative to the start of the assigned signal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seq_segs</span> <span class="o">=</span> <span class="n">valid_cpts</span><span class="p">[</span><span class="n">seq_events</span><span class="p">]</span>
    <span class="n">read_start_rel_to_raw</span> <span class="o">=</span> <span class="n">seq_segs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">seq_segs</span> <span class="o">=</span> <span class="n">seq_segs</span> <span class="o">-</span> <span class="n">read_start_rel_to_raw</span>
    <span class="k">return</span> <span class="n">seq_segs</span><span class="p">,</span> <span class="n">read_start_rel_to_raw</span>

<div class="viewcode-block" id="find_adaptive_base_assignment"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.find_adaptive_base_assignment">[docs]</a><span class="k">def</span> <span class="nf">find_adaptive_base_assignment</span><span class="p">(</span>
        <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">,</span>
        <span class="n">start_clip_bases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_clip_params</span><span class="o">=</span><span class="n">START_CLIP_PARAMS</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">reg_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Align expected (from genome sequence) signal levels to observed using a dynamic programming approach with adaptive bandwidth start positions</span>

<span class="sd">    Args:</span>
<span class="sd">        valid_cpts (`np.array::np.int64`): raw signal base start locations</span>
<span class="sd">        event_means (`np.array::np.float64`): event normalized raw signal means</span>
<span class="sd">        rsqgl_params (:class:`tombo.tombo_helper.resquiggleParams`): parameters for the re-squiggle algorithm</span>
<span class="sd">        std_ref (:class:`tombo.tombo_stats.TomboModel`): canonical model</span>
<span class="sd">        genome_seq (str): genome sequence (from mapping)</span>
<span class="sd">        start_clip_bases (str): mapping read clipped bases</span>
<span class="sd">        start_clip_params (:class:`tombo.tombo_helper.startClipParams`): start clip basecall params</span>
<span class="sd">        seq_samp_type (:class:`tombo.tombo_helper.seqSampleType`): sequencing sample type (default: DNA)</span>
<span class="sd">        reg_id (str): debug</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`tombo.tombo_helper.dpResults`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_short_read_results</span><span class="p">(</span><span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">):</span>
        <span class="n">seq_events</span> <span class="o">=</span> <span class="n">find_static_base_assignment</span><span class="p">(</span>
            <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="n">reg_id</span><span class="p">)</span>
        <span class="n">seq_segs</span><span class="p">,</span> <span class="n">read_start_rel_to_raw</span> <span class="o">=</span> <span class="n">get_rel_raw_coords</span><span class="p">(</span>
            <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">seq_events</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">th</span><span class="o">.</span><span class="n">dpResults</span><span class="p">(</span>
            <span class="n">read_start_rel_to_raw</span><span class="o">=</span><span class="n">read_start_rel_to_raw</span><span class="p">,</span> <span class="n">segs</span><span class="o">=</span><span class="n">seq_segs</span><span class="p">,</span>
            <span class="n">ref_means</span><span class="o">=</span><span class="n">r_ref_means</span><span class="p">,</span> <span class="n">ref_sds</span><span class="o">=</span><span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">genome_seq</span><span class="o">=</span><span class="n">genome_seq</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_fwd_pass</span><span class="p">():</span>
        <span class="c1"># find full sequence to events path using a smaller bandwidth</span>
        <span class="p">(</span><span class="n">start_fwd_pass</span><span class="p">,</span> <span class="n">start_fwd_pass_move</span><span class="p">,</span>
         <span class="n">start_event_starts</span><span class="p">,</span> <span class="n">start_z_scores</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_masked_start_fwd_pass</span><span class="p">(</span>
             <span class="n">event_means</span><span class="p">[</span><span class="n">events_start_clip</span><span class="p">:],</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span>
             <span class="n">mapped_start_offset</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">events_per_base</span><span class="p">)</span>
        <span class="n">start_seq_len</span> <span class="o">=</span> <span class="n">start_event_starts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fwd_pass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">fwd_pass</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_fwd_pass</span>
        <span class="n">fwd_pass_move</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">fwd_pass_move</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_fwd_pass_move</span>
        <span class="n">band_event_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">seq_len</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">band_event_starts</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_event_starts</span>

        <span class="c1"># if max_half_z_score is none set it to valid float for cython</span>
        <span class="c1"># z-score computation</span>
        <span class="k">if</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">do_winsorize_z</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">wa_rsqgl_params</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">max_half_z_score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_winsorize_z</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">wa_rsqgl_params</span> <span class="o">=</span> <span class="n">rsqgl_params</span>

        <span class="n">shifted_z_scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">_DEBUG_FIT</span> <span class="ow">or</span> <span class="n">_DEBUG_BANDWIDTH</span> <span class="ow">or</span> <span class="n">_DEBUG_DP_ENDS</span><span class="p">:</span>
            <span class="c1"># save z-scores for debug plotting</span>
            <span class="n">rest_z_scores</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">adaptive_banded_forward_pass</span><span class="p">(</span>
                <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span>
                <span class="n">event_means</span><span class="p">[</span><span class="n">events_start_clip</span><span class="p">:],</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span>
                <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span><span class="p">,</span> <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span>
                <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">stay_pen</span><span class="p">,</span> <span class="n">start_seq_len</span><span class="p">,</span> <span class="n">MASK_FILL_Z_SCORE</span><span class="p">,</span>
                <span class="n">do_winsorize_z</span><span class="p">,</span> <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">,</span>
                <span class="n">return_z_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shifted_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span>
                <span class="n">seq_len</span><span class="p">,</span> <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">shifted_z_scores</span><span class="p">[:</span><span class="n">start_seq_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_z_scores</span>
            <span class="n">shifted_z_scores</span><span class="p">[</span><span class="n">start_seq_len</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rest_z_scores</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">adaptive_banded_forward_pass</span><span class="p">(</span>
                <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span>
                <span class="n">event_means</span><span class="p">[</span><span class="n">events_start_clip</span><span class="p">:],</span>
                <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">z_shift</span><span class="p">,</span>
                <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">skip_pen</span><span class="p">,</span> <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">stay_pen</span><span class="p">,</span> <span class="n">start_seq_len</span><span class="p">,</span>
                <span class="n">MASK_FILL_Z_SCORE</span><span class="p">,</span> <span class="n">do_winsorize_z</span><span class="p">,</span>
                <span class="n">wa_rsqgl_params</span><span class="o">.</span><span class="n">max_half_z_score</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">shifted_z_scores</span>

    <span class="k">def</span> <span class="nf">plot_debug</span><span class="p">(</span><span class="n">shifted_z_scores</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_DEBUG_FIT</span> <span class="ow">or</span> <span class="n">_DEBUG_BANDWIDTH</span><span class="p">:</span>
            <span class="n">_debug_fit</span><span class="p">(</span>
                <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span> <span class="n">shifted_z_scores</span><span class="p">,</span>
                <span class="n">reg_id</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">],</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">,</span>
                <span class="n">event_means</span><span class="p">[</span><span class="n">events_start_clip</span><span class="p">:],</span> <span class="n">r_ref_means</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_DEBUG_DP_ENDS</span><span class="p">:</span>
            <span class="n">_debug_plot_dp</span><span class="p">(</span><span class="n">shifted_z_scores</span><span class="p">,</span> <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span>
                           <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span> <span class="n">reg_id</span><span class="p">)</span>
        <span class="k">return</span>


    <span class="c1"># if start clip bases are provided, run &quot;cliped bases&quot; start</span>
    <span class="c1"># identification algorithm</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start_clip_bases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">genome_seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">start_clip_params</span><span class="o">.</span><span class="n">num_genome_bases</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_clip_bases</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">:</span>
            <span class="n">mapped_start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_clip_bases</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">events_per_base</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clip_params</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">bandwidth</span><span class="o">=</span><span class="n">start_clip_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">)</span>
            <span class="n">mapped_start</span><span class="p">,</span> <span class="n">events_per_base</span> <span class="o">=</span> <span class="n">find_seq_start_from_clip_basecalls</span><span class="p">(</span>
                <span class="n">event_means</span><span class="p">,</span> <span class="n">clip_params</span><span class="p">,</span> <span class="n">start_clip_bases</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
                <span class="n">start_clip_params</span><span class="o">.</span><span class="n">num_genome_bases</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="n">reg_id</span><span class="p">)</span>

    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">get_exp_levels_from_seq</span><span class="p">(</span><span class="n">genome_seq</span><span class="p">)</span>
    <span class="c1"># trim genome seq to match model-able positions</span>
    <span class="n">genome_seq</span> <span class="o">=</span> <span class="n">genome_seq</span><span class="p">[</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">:</span><span class="o">-</span><span class="n">dnstrm_bases</span><span class="p">]</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">genome_seq</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">seq_len</span> <span class="o">!=</span> <span class="n">r_ref_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Discordant reference and seqeunce lengths.&#39;</span><span class="p">)</span>

    <span class="c1"># if read was too short for start clip map start discovery, but need r_ref*</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start_clip_bases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
        <span class="n">seq_len</span> <span class="o">&lt;=</span> <span class="n">start_clip_params</span><span class="o">.</span><span class="n">num_genome_bases</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_short_read_results</span><span class="p">(</span><span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">start_clip_bases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># for short reads, just search the whole read with an appropriate</span>
        <span class="c1"># bandwidth</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_bw</span> <span class="o">+</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_n_bases</span> <span class="ow">or</span>
            <span class="n">seq_len</span> <span class="o">&lt;</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_n_bases</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">get_short_read_results</span><span class="p">(</span><span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># identify the start of genomic sequence within raw signal</span>
            <span class="n">mapped_start</span><span class="p">,</span> <span class="n">events_per_base</span> <span class="o">=</span> <span class="n">find_seq_start_in_events</span><span class="p">(</span>
                <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span>
                <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_n_bases</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_bw</span><span class="p">,</span>
                <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="n">reg_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_save_bw</span> <span class="o">+</span>
                <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_n_bases</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">get_short_read_results</span><span class="p">(</span><span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">)</span>
            <span class="c1"># if smaller (and faster) bandwidth did not find a sufficiently</span>
            <span class="c1"># scoring raw signal mapping, try again with larger save_bandwidth</span>
            <span class="c1"># and don&#39;t check score (by not passing seq_samp_type)</span>
            <span class="n">mapped_start</span><span class="p">,</span> <span class="n">events_per_base</span> <span class="o">=</span> <span class="n">find_seq_start_in_events</span><span class="p">(</span>
                <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span>
                <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_n_bases</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">start_save_bw</span><span class="p">,</span>
                <span class="n">reg_id</span><span class="o">=</span><span class="n">reg_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">events_per_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Very poor signal quality. Read likely includes open pore.&#39;</span><span class="p">)</span>

    <span class="c1"># get number of events to clip and how far into the events the</span>
    <span class="c1"># discovered start is located</span>
    <span class="n">half_bandwidth</span> <span class="o">=</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">mapped_start</span> <span class="o">&lt;</span> <span class="n">half_bandwidth</span><span class="p">:</span>
        <span class="n">events_start_clip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mapped_start_offset</span> <span class="o">=</span> <span class="n">mapped_start</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">events_start_clip</span> <span class="o">=</span> <span class="n">mapped_start</span> <span class="o">-</span> <span class="n">half_bandwidth</span>
        <span class="n">mapped_start_offset</span> <span class="o">=</span> <span class="n">half_bandwidth</span>

    <span class="c1"># process long enough reads that start too far into read for normal</span>
    <span class="c1"># adaptive processing just as with short reads</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">half_bandwidth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">events_per_base</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">r_ref_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mapped_start_offset</span> <span class="o">-</span>
         <span class="n">events_start_clip</span> <span class="o">&lt;</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">get_short_read_results</span><span class="p">(</span><span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">genome_seq</span><span class="p">)</span>

    <span class="n">fwd_pass</span><span class="p">,</span> <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">shifted_z_scores</span> <span class="o">=</span> <span class="n">run_fwd_pass</span><span class="p">()</span>

    <span class="c1"># find position of last base at the maximal score</span>
    <span class="n">top_max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">fwd_pass</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>

    <span class="c1"># plot debugging if requested</span>
    <span class="n">plot_debug</span><span class="p">(</span><span class="n">shifted_z_scores</span><span class="p">)</span>

    <span class="n">read_tb</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">banded_traceback</span><span class="p">(</span>
        <span class="n">fwd_pass_move</span><span class="p">,</span> <span class="n">band_event_starts</span><span class="p">,</span> <span class="n">top_max_pos</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">band_bound_thresh</span><span class="p">)</span>
    <span class="c1"># trim invalid traceback positions</span>
    <span class="n">read_tb</span> <span class="o">=</span> <span class="n">_trim_traceback</span><span class="p">(</span>
        <span class="n">read_tb</span><span class="p">,</span> <span class="n">events_len</span><span class="o">=</span><span class="n">event_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">events_start_clip</span><span class="p">)</span>

    <span class="c1"># get segment positions within raw signal vector</span>
    <span class="n">seq_segs</span><span class="p">,</span> <span class="n">read_start_rel_to_raw</span> <span class="o">=</span> <span class="n">get_rel_raw_coords</span><span class="p">(</span>
        <span class="n">valid_cpts</span><span class="p">[</span><span class="n">events_start_clip</span><span class="p">:],</span> <span class="n">read_tb</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">th</span><span class="o">.</span><span class="n">dpResults</span><span class="p">(</span>
        <span class="n">read_start_rel_to_raw</span><span class="o">=</span><span class="n">read_start_rel_to_raw</span><span class="p">,</span> <span class="n">segs</span><span class="o">=</span><span class="n">seq_segs</span><span class="p">,</span>
        <span class="n">ref_means</span><span class="o">=</span><span class="n">r_ref_means</span><span class="p">,</span> <span class="n">ref_sds</span><span class="o">=</span><span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">genome_seq</span><span class="o">=</span><span class="n">genome_seq</span><span class="p">)</span></div>


<span class="c1">######################################</span>
<span class="c1">########## Re-squiggle Read ##########</span>
<span class="c1">######################################</span>

<div class="viewcode-block" id="segment_signal"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.segment_signal">[docs]</a><span class="k">def</span> <span class="nf">segment_signal</span><span class="p">(</span>
        <span class="n">map_res</span><span class="p">,</span> <span class="n">num_events</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">const_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Normalize and segment raw signal as defined by `rsqgl_params` into `num_events`.</span>

<span class="sd">    Args:</span>
<span class="sd">        map_res (:class:`tombo.tombo_helper.resquiggleResults`): containing mapping results only (attributes after ``read_start_rel_to_raw`` will all be ``None``)</span>
<span class="sd">        num_events (int): number of events to process</span>
<span class="sd">        rsqgl_params (:class:`tombo.tombo_helper.resquiggleParams`): parameters for the re-squiggle algorithm</span>
<span class="sd">        outlier_thresh (float): windsorize signal greater than this value (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        1) identified event positions (0-based)</span>
<span class="sd">        2) normalized raw signal</span>
<span class="sd">        3) scale values (:class:`tombo.tombo_helper.scaleValues`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">use_t_test_seg</span><span class="p">:</span>
        <span class="c1"># RNA bases show consistent variable spread so use t-test segmentation</span>
        <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">valid_cpts_w_cap_t_test</span><span class="p">(</span>
            <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">min_obs_per_base</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">running_stat_width</span><span class="p">,</span> <span class="n">num_events</span><span class="p">)</span>

        <span class="c1"># remove cpts within stall locations</span>
        <span class="k">if</span> <span class="n">map_res</span><span class="o">.</span><span class="n">stall_ints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">remove_stall_cpts</span><span class="p">(</span><span class="n">map_res</span><span class="o">.</span><span class="n">stall_ints</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">map_res</span><span class="o">.</span><span class="n">scale_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">normalize_raw_signal</span><span class="p">(</span>
                <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">scale_values</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">scale_values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">const_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">normalize_raw_signal</span><span class="p">(</span>
                <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;median_const_scale&#39;</span><span class="p">,</span>
                <span class="n">outlier_thresh</span><span class="o">=</span><span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">const_scale</span><span class="o">=</span><span class="n">const_scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">USE_RNA_EVENT_SCALE</span><span class="p">:</span>
                <span class="n">scale_values</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_scale_values_from_events</span><span class="p">(</span>
                    <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span>
                    <span class="n">num_events</span><span class="o">=</span><span class="n">RNA_SCALE_NUM_EVENTS</span><span class="p">,</span>
                    <span class="n">max_frac_events</span><span class="o">=</span><span class="n">RNA_SCALE_MAX_FRAC_EVENTS</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale_values</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">normalize_raw_signal</span><span class="p">(</span>
                <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">scale_values</span><span class="o">=</span><span class="n">scale_values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># normalize signal</span>
        <span class="k">if</span> <span class="n">map_res</span><span class="o">.</span><span class="n">scale_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">normalize_raw_signal</span><span class="p">(</span>
                <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">scale_values</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">scale_values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">const_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">normalize_raw_signal</span><span class="p">(</span>
                <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;median_const_scale&#39;</span><span class="p">,</span>
                <span class="n">outlier_thresh</span><span class="o">=</span><span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">const_scale</span><span class="o">=</span><span class="n">const_scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">normalize_raw_signal</span><span class="p">(</span>
                <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                <span class="n">outlier_thresh</span><span class="o">=</span><span class="n">outlier_thresh</span><span class="p">)</span>

        <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">valid_cpts_w_cap</span><span class="p">(</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">min_obs_per_base</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">running_stat_width</span><span class="p">,</span> <span class="n">num_events</span><span class="p">)</span>
        <span class="c1"># remove cpts within stall locations</span>
        <span class="k">if</span> <span class="n">map_res</span><span class="o">.</span><span class="n">stall_ints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">remove_stall_cpts</span><span class="p">(</span><span class="n">map_res</span><span class="o">.</span><span class="n">stall_ints</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span></div>

<div class="viewcode-block" id="resquiggle_read"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.resquiggle_read">[docs]</a><span class="k">def</span> <span class="nf">resquiggle_read</span><span class="p">(</span>
        <span class="n">map_res</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">all_raw_signal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_raw_cpts</span><span class="o">=</span><span class="n">MAX_RAW_CPTS</span><span class="p">,</span>
        <span class="n">min_event_to_seq_ratio</span><span class="o">=</span><span class="n">MIN_EVENT_TO_SEQ_RATIO</span><span class="p">,</span> <span class="n">const_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_seq_scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Identify raw signal to genome sequence assignment, using adaptive banded dynamic programming</span>

<span class="sd">    Args:</span>
<span class="sd">        map_res (:class:`tombo.tombo_helper.resquiggleResults`): mapping results</span>
<span class="sd">        std_ref (:class:`tombo.tombo_stats.TomboModel`): canonical base model</span>
<span class="sd">        rsqgl_params (:class:`tombo.tombo_helper.resquiggleParams`): parameters for the re-squiggle algorithm</span>
<span class="sd">        outlier_thresh (float): windsorize signal greater than this value (optional)</span>
<span class="sd">        all_raw_signal (`np.array::np.int64`): raw data acquisition (DAC) current signal values (optional; default use value in map_res)</span>
<span class="sd">        max_raw_cpts (int): read will fail if more than `max_raw_cpts` must be found to produce a valid re-squiggle results (optional)</span>
<span class="sd">        min_event_to_seq_ratio (float): minimum event to sequence ratio (optional)</span>
<span class="sd">        const_scale (float): constant scale value (optional; may be deprecated)</span>
<span class="sd">        skip_seq_scaling (bool): skip sequence-based scaling step</span>
<span class="sd">        seq_samp_type (:class:`tombo.tombo_helper.seqSampleType`): sequencing sample type (default: DNA)</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`tombo.tombo_helper.resquiggleResults` containing raw signal to genome sequence alignment (note that ``raw_signal`` now contains trimmed and normalized raw signal)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">all_raw_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">map_res</span> <span class="o">=</span> <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">raw_signal</span> <span class="o">=</span> <span class="n">all_raw_signal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Must have raw signal in order to complete re-squiggle algorithm&#39;</span><span class="p">)</span>

    <span class="c1"># compute number of events to find</span>
    <span class="c1"># ensure at least a minimal number of events per mapped sequence are found</span>
    <span class="n">num_mapped_bases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">map_res</span><span class="o">.</span><span class="n">genome_seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">num_events</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">compute_num_events</span><span class="p">(</span>
        <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_mapped_bases</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">mean_obs_per_event</span><span class="p">,</span> <span class="n">min_event_to_seq_ratio</span><span class="p">)</span>
    <span class="c1"># ensure that there isn&#39;t *far* too much signal for the mapped sequence</span>
    <span class="c1"># i.e. one adaptive bandwidth per base is too much to find a good mapping</span>
    <span class="k">if</span> <span class="n">num_events</span> <span class="o">/</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">&gt;</span> <span class="n">num_mapped_bases</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Too much raw signal for mapped sequence&#39;</span><span class="p">)</span>

    <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">norm_signal</span><span class="p">,</span> <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">segment_signal</span><span class="p">(</span>
        <span class="n">map_res</span><span class="p">,</span> <span class="n">num_events</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">const_scale</span><span class="p">)</span>
    <span class="n">event_means</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">compute_base_means</span><span class="p">(</span><span class="n">norm_signal</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">)</span>

    <span class="n">dp_res</span> <span class="o">=</span> <span class="n">find_adaptive_base_assignment</span><span class="p">(</span>
        <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">map_res</span><span class="o">.</span><span class="n">genome_seq</span><span class="p">,</span>
        <span class="n">start_clip_bases</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">start_clip_bases</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">align_info</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
    <span class="c1"># clip raw signal to only part mapping to genome seq</span>
    <span class="n">norm_signal</span> <span class="o">=</span> <span class="n">norm_signal</span><span class="p">[</span><span class="n">dp_res</span><span class="o">.</span><span class="n">read_start_rel_to_raw</span><span class="p">:</span>
                              <span class="n">dp_res</span><span class="o">.</span><span class="n">read_start_rel_to_raw</span> <span class="o">+</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># identify all stretches of genomic deletions within del_fix_window</span>
    <span class="c1"># to be fixed.</span>
    <span class="n">segs</span> <span class="o">=</span> <span class="n">resolve_skipped_bases_with_raw</span><span class="p">(</span>
        <span class="n">dp_res</span><span class="p">,</span> <span class="n">norm_signal</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">max_raw_cpts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">skip_seq_scaling</span><span class="p">:</span>
        <span class="n">norm_params_changed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shift_corr_factor</span><span class="p">,</span>
         <span class="n">scale_corr_factor</span><span class="p">)</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">calc_kmer_fitted_shift_scale</span><span class="p">(</span>
             <span class="n">new_scale_values</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">new_scale_values</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
             <span class="n">ts</span><span class="o">.</span><span class="n">compute_base_means</span><span class="p">(</span><span class="n">norm_signal</span><span class="p">,</span> <span class="n">segs</span><span class="p">),</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">ref_means</span><span class="p">,</span>
             <span class="n">method</span><span class="o">=</span><span class="s1">&#39;theil_sen&#39;</span><span class="p">)</span>
        <span class="n">new_scale_values</span> <span class="o">=</span> <span class="n">new_scale_values</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="o">=</span><span class="n">outlier_thresh</span><span class="p">)</span>
        <span class="c1"># re-normalize signal with new fitted parameters</span>
        <span class="n">norm_signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm_signal</span> <span class="o">-</span> <span class="n">shift_corr_factor</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_corr_factor</span>
        <span class="c1"># determine if normalization parameters changed enough to warrant</span>
        <span class="c1"># re-squiggling again</span>
        <span class="n">norm_params_changed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shift_corr_factor</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SHIFT_CHANGE_THRESH</span> <span class="ow">or</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">scale_corr_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SCALE_CHANGE_THRESH</span><span class="p">)</span>

    <span class="n">sig_match_score</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_read_seg_score</span><span class="p">(</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">compute_base_means</span><span class="p">(</span><span class="n">norm_signal</span><span class="p">,</span> <span class="n">segs</span><span class="p">),</span>
        <span class="n">dp_res</span><span class="o">.</span><span class="n">ref_means</span><span class="p">,</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">ref_sds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">segs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp_res</span><span class="o">.</span><span class="n">genome_seq</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Aligned sequence does not match number &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;of segments produced&#39;</span><span class="p">)</span>

    <span class="c1"># Output for testing/visualization of re-squiggle</span>
    <span class="k">if</span> <span class="n">_DEBUG_PARAMS</span><span class="p">:</span>
        <span class="n">_write_params_debug</span><span class="p">(</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">ref_means</span><span class="p">,</span> <span class="n">dp_res</span><span class="o">.</span><span class="n">ref_sds</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">map_res</span><span class="o">.</span><span class="n">align_info</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
        <span class="n">read_start_rel_to_raw</span><span class="o">=</span><span class="n">dp_res</span><span class="o">.</span><span class="n">read_start_rel_to_raw</span><span class="p">,</span> <span class="n">segs</span><span class="o">=</span><span class="n">segs</span><span class="p">,</span>
        <span class="n">genome_seq</span><span class="o">=</span><span class="n">dp_res</span><span class="o">.</span><span class="n">genome_seq</span><span class="p">,</span> <span class="n">raw_signal</span><span class="o">=</span><span class="n">norm_signal</span><span class="p">,</span>
        <span class="n">scale_values</span><span class="o">=</span><span class="n">new_scale_values</span><span class="p">,</span> <span class="n">sig_match_score</span><span class="o">=</span><span class="n">sig_match_score</span><span class="p">,</span>
        <span class="n">norm_params_changed</span><span class="o">=</span><span class="n">norm_params_changed</span><span class="p">)</span></div>


<span class="c1">#######################################</span>
<span class="c1">########## Genomic Alignment ##########</span>
<span class="c1">#######################################</span>

<div class="viewcode-block" id="get_read_seq"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.get_read_seq">[docs]</a><span class="k">def</span> <span class="nf">get_read_seq</span><span class="p">(</span>
        <span class="n">fast5_data</span><span class="p">,</span> <span class="n">bc_grp</span><span class="o">=</span><span class="s1">&#39;Basecall_1D_000&#39;</span><span class="p">,</span> <span class="n">bc_subgrp</span><span class="o">=</span><span class="s1">&#39;BaseCalled_template&#39;</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">q_score_thresh</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract read sequence from the Fastq slot providing useful error messages</span>

<span class="sd">    Args:</span>

<span class="sd">        fast5_data (:class:`tombo.tombo_helper.readData`): read information</span>
<span class="sd">        bc_grp (str): group location containing read information (optional; default: &#39;Basecall_1D_000&#39;)</span>
<span class="sd">        bc_subgrp (str): sub-group location containing read information (optional; default: &#39;BaseCalled_template&#39;)</span>
<span class="sd">        seq_samp_type (:class:`tombo.tombo_helper.seqSampleType`): sequencing sample type (default: DNA)</span>
<span class="sd">        q_score_thresh (float): basecalling mean q-score threshold (optional; default: 0/no filtering)</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`tombo.tombo_helper.sequenceData`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fastq_raw_value</span> <span class="o">=</span> <span class="n">fast5_data</span><span class="p">[</span>
            <span class="s1">&#39;/Analyses/&#39;</span> <span class="o">+</span> <span class="n">bc_grp</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">bc_subgrp</span> <span class="o">+</span> <span class="s1">&#39;/Fastq&#39;</span><span class="p">][()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Fastq slot not present in --basecall-group&#39;</span><span class="p">)</span>

    <span class="c1"># depending on how fastq data was stored it may already be encoded</span>
    <span class="c1"># as unicode, so this would fail.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fastq_raw_value</span> <span class="o">=</span> <span class="n">fastq_raw_value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">s_fastq</span> <span class="o">=</span> <span class="n">fastq_raw_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">read_seq</span><span class="p">,</span> <span class="n">read_q</span> <span class="o">=</span> <span class="n">s_fastq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_fastq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># compute read q-score</span>
    <span class="n">mean_q_score</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_mean_q_score</span><span class="p">(</span><span class="n">read_q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q_score_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mean_q_score</span> <span class="o">&lt;</span> <span class="n">q_score_thresh</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Read filtered by q-score.&#39;</span><span class="p">)</span>

    <span class="n">read_data</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span>

    <span class="c1"># looks like read_id attribute has been removed in some files and attribute</span>
    <span class="c1"># is not really necessary for tombo</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">read_id</span> <span class="o">=</span> <span class="n">read_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">read_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;read_num&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000000000</span><span class="p">))</span>

    <span class="c1"># only really here for the API</span>
    <span class="k">if</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_sample_type</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">RNA_SAMP_TYPE</span><span class="p">:</span>
        <span class="n">read_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_transcribe</span><span class="p">(</span><span class="n">read_seq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">th</span><span class="o">.</span><span class="n">sequenceData</span><span class="p">(</span><span class="n">seq</span><span class="o">=</span><span class="n">read_seq</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">read_id</span><span class="p">,</span> <span class="n">mean_q_score</span><span class="o">=</span><span class="n">mean_q_score</span><span class="p">)</span></div>

<div class="viewcode-block" id="map_read"><a class="viewcode-back" href="../../tombo.html#tombo.resquiggle.map_read">[docs]</a><span class="k">def</span> <span class="nf">map_read</span><span class="p">(</span>
        <span class="n">fast5_data</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">bc_grp</span><span class="o">=</span><span class="s1">&#39;Basecall_1D_000&#39;</span><span class="p">,</span> <span class="n">bc_subgrp</span><span class="o">=</span><span class="s1">&#39;BaseCalled_template&#39;</span><span class="p">,</span>
        <span class="n">map_thr_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seq_len_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract read sequence from the Fastq slot providing useful error messages</span>

<span class="sd">    Args:</span>
<span class="sd">        fast5_data (:class:`tombo.tombo_helper.readData`): read information</span>
<span class="sd">        aligner (mappy.Aligner): aligner object</span>
<span class="sd">        std_ref (:class:`tombo.tombo_stats.TomboModel`): canonical model (in order to extract extended genomic sequence)</span>
<span class="sd">        seq_samp_type (:class:`tombo.tombo_helper.seqSampleType`): sequencing sample type (default: DNA)</span>
<span class="sd">        bc_grp (str): group location containing read information (optional; default: &#39;Basecall_1D_000&#39;)</span>
<span class="sd">        bc_subgrp (str): sub-group location containing read information (optional; default: &#39;BaseCalled_template&#39;)</span>
<span class="sd">        map_thr_buf (mappy.ThreadBuffer): mappy thread buffer object (optional; default: None)</span>
<span class="sd">        q_score_thresh (float): basecalling mean q-score threshold (optional; default: 0/no filtering)</span>
<span class="sd">        seq_len_rng (tuple): allowed mapped sequence length range (optional; default: None/no filtering)</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`tombo.tombo_helper.resquiggleResults` containing valid mapping values (signal to sequence assignment attributes will be ``None``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seq_data</span> <span class="o">=</span> <span class="n">get_read_seq</span><span class="p">(</span>
        <span class="n">fast5_data</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span> <span class="n">bc_subgrp</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># enumerate all alignments to avoid mappy memory leak</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aligner</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">seq_data</span><span class="o">.</span><span class="n">seq</span><span class="p">),</span> <span class="n">buf</span><span class="o">=</span><span class="n">map_thr_buf</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Alignment not produced&#39;</span><span class="p">)</span>

    <span class="n">chrm</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">ctg</span>
    <span class="c1"># subtract one to put into 0-based index</span>
    <span class="n">ref_start</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">r_st</span>
    <span class="n">ref_end</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">r_en</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">seq_len_rng</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="n">seq_len_rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ref_end</span> <span class="o">-</span> <span class="n">ref_start</span> <span class="o">&lt;</span> <span class="n">seq_len_rng</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Mapped location not within --sequence-length-range&#39;</span><span class="p">)</span>
    <span class="n">strand</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">alignment</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">num_match</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">mlen</span>
    <span class="n">num_ins</span><span class="p">,</span> <span class="n">num_del</span><span class="p">,</span> <span class="n">num_aligned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">op_len</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">alignment</span><span class="o">.</span><span class="n">cigar</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">num_ins</span> <span class="o">+=</span> <span class="n">op_len</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span> <span class="n">num_del</span> <span class="o">+=</span> <span class="n">op_len</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span> <span class="n">num_aligned</span> <span class="o">+=</span> <span class="n">op_len</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># soft and hard clipping are not reported in the</span>
            <span class="c1"># mappy cigar</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Invalid cigar operation&#39;</span><span class="p">)</span>

    <span class="c1"># store number of clipped bases relative to read sequence</span>
    <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="n">num_start_clipped_bases</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">q_st</span>
        <span class="n">num_end_clipped_bases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_data</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">alignment</span><span class="o">.</span><span class="n">q_en</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_start_clipped_bases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_data</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">alignment</span><span class="o">.</span><span class="n">q_en</span>
        <span class="n">num_end_clipped_bases</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">q_st</span>

    <span class="n">align_info</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">alignInfo</span><span class="p">(</span>
        <span class="n">seq_data</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">bc_subgrp</span><span class="p">,</span> <span class="n">num_start_clipped_bases</span><span class="p">,</span>
        <span class="n">num_end_clipped_bases</span><span class="p">,</span> <span class="n">num_ins</span><span class="p">,</span> <span class="n">num_del</span><span class="p">,</span> <span class="n">num_match</span><span class="p">,</span>
        <span class="n">num_aligned</span> <span class="o">-</span> <span class="n">num_match</span><span class="p">)</span>

    <span class="c1"># extract genome sequence from mappy aligner</span>
    <span class="c1"># expand sequence to get model levels for all sites (need to handle new</span>
    <span class="c1"># sequence coordinates downstream)</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">RNA_SAMP_TYPE</span> <span class="ow">and</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DNA_SAMP_TYPE</span> <span class="ow">and</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span>
         <span class="n">USE_START_CLIP_BASES</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DNA_SAMP_TYPE</span> <span class="ow">and</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="ow">and</span>
         <span class="ow">not</span> <span class="n">USE_START_CLIP_BASES</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">ref_start</span> <span class="o">&lt;</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">:</span>
            <span class="n">ref_start</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span>
        <span class="n">ref_seq_start</span> <span class="o">=</span> <span class="n">ref_start</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span>
        <span class="n">ref_seq_end</span> <span class="o">=</span> <span class="n">ref_end</span> <span class="o">+</span> <span class="n">dnstrm_bases</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ref_start</span> <span class="o">&lt;</span> <span class="n">dnstrm_bases</span><span class="p">:</span>
            <span class="n">ref_start</span> <span class="o">=</span> <span class="n">dnstrm_bases</span>
        <span class="n">ref_seq_start</span> <span class="o">=</span> <span class="n">ref_start</span> <span class="o">-</span> <span class="n">dnstrm_bases</span>
        <span class="n">ref_seq_end</span> <span class="o">=</span> <span class="n">ref_end</span> <span class="o">+</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span>
    <span class="n">genome_seq</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">ref_seq_start</span><span class="p">,</span> <span class="n">ref_seq_end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">genome_seq</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">genome_seq</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span><span class="s1">&#39;Invalid mapping location&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">genome_seq</span> <span class="o">=</span> <span class="n">genome_seq</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">genome_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">genome_seq</span><span class="p">)</span>
    <span class="c1"># discordant mapping to sequence extraction is due to reads mapping up to</span>
    <span class="c1"># the end of a seqeunce record (and don&#39;t need to carry around record lens),</span>
    <span class="c1"># so don&#39;t error on these discordant lengths here</span>
    <span class="c1">#if len(genome_seq) != ref_end - ref_start + std_ref.kmer_width - 1:</span>
    <span class="c1">#    raise th.TomboError(&#39;Discordant mapped position and sequence&#39;)</span>
    <span class="n">genome_loc</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">genomeLocation</span><span class="p">(</span><span class="n">ref_start</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">chrm</span><span class="p">)</span>

    <span class="c1"># store sequence at the end of the read without an adapter</span>
    <span class="c1"># for simpler read start identification (start of RNA genomic sequence</span>
    <span class="c1"># end of DNA genomic sequence)</span>
    <span class="n">start_clip_bases</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">USE_START_CLIP_BASES</span><span class="p">:</span>
        <span class="n">start_clip_bases</span> <span class="o">=</span> <span class="n">seq_data</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">alignment</span><span class="o">.</span><span class="n">q_en</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">th</span><span class="o">.</span><span class="n">resquiggleResults</span><span class="p">(</span>
        <span class="n">align_info</span><span class="o">=</span><span class="n">align_info</span><span class="p">,</span> <span class="n">genome_loc</span><span class="o">=</span><span class="n">genome_loc</span><span class="p">,</span> <span class="n">genome_seq</span><span class="o">=</span><span class="n">genome_seq</span><span class="p">,</span>
        <span class="n">mean_q_score</span><span class="o">=</span><span class="n">seq_data</span><span class="o">.</span><span class="n">mean_q_score</span><span class="p">,</span> <span class="n">start_clip_bases</span><span class="o">=</span><span class="n">start_clip_bases</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_io_and_map_read</span><span class="p">(</span>
        <span class="n">fast5_data</span><span class="p">,</span> <span class="n">failed_reads_q</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">map_thr_buf</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="n">num_processed</span><span class="p">,</span> <span class="n">map_conn</span><span class="p">,</span>
        <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">compute_sd</span><span class="p">,</span> <span class="n">obs_filter</span><span class="p">,</span> <span class="n">index_q</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="p">,</span>
        <span class="n">sig_match_thresh</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">sig_len_rng</span><span class="p">,</span> <span class="n">seq_len_rng</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># extract channel and raw data for this read</span>
        <span class="n">channel_info</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_channel_info</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">:</span>
        <span class="c1"># channel info is not needed currently, so just pass</span>
        <span class="n">channel_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">all_raw_signal</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)[</span><span class="s1">&#39;Signal&#39;</span><span class="p">][:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sig_len_rng</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="n">sig_len_rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sig_len_rng</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Raw signal not within --signal-length-range&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bc_subgrp</span> <span class="ow">in</span> <span class="n">bc_subgrps</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">map_res</span> <span class="o">=</span> <span class="n">map_read</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span> <span class="n">bc_subgrp</span><span class="p">,</span>
                <span class="n">map_thr_buf</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="p">,</span> <span class="n">seq_len_rng</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">invalid_seq</span><span class="p">(</span><span class="n">map_res</span><span class="o">.</span><span class="n">genome_seq</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                    <span class="s1">&#39;Reference mapping contains non-canonical bases &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;(transcriptome reference cannot contain U bases)&#39;</span><span class="p">)</span>
            <span class="n">map_res</span> <span class="o">=</span> <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">raw_signal</span><span class="o">=</span><span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">channel_info</span><span class="o">=</span><span class="n">channel_info</span><span class="p">)</span>

            <span class="c1"># send mapping data to _resquiggle_worker process</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">map_conn</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="n">map_res</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">])</span>
                <span class="c1"># wait until re-squiggle returns</span>
                <span class="n">read_failed</span><span class="p">,</span> <span class="n">rsqgl_res</span> <span class="o">=</span> <span class="n">map_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">EOFError</span><span class="p">,</span> <span class="ne">BrokenPipeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="n">_BROKEN_PIPE_ERR</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">read_failed</span><span class="p">:</span>
                <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                    <span class="n">rsqgl_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bc_subgrp</span> <span class="o">+</span> <span class="s1">&#39;:::&#39;</span> <span class="o">+</span> <span class="n">rsqgl_res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">rsqgl_res</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_DRY_RUN</span><span class="p">:</span>
                <span class="c1"># write re-squiggle event assignment to the read FAST5 file</span>
                <span class="n">th</span><span class="o">.</span><span class="n">write_new_fast5_group</span><span class="p">(</span>
                    <span class="n">fast5_data</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">rsqgl_res</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">compute_sd</span><span class="p">,</span>
                    <span class="n">rna</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">rev_sig</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">index_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># check that read passes reversible filters</span>
                <span class="n">is_filtered</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">sig_match_score</span> <span class="o">&gt;</span> <span class="n">sig_match_thresh</span><span class="p">:</span>
                    <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                        <span class="s1">&#39;Poor raw to expected signal matching &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;(revert with `tombo filter clear_filters`)&#39;</span><span class="p">,</span>
                        <span class="n">bc_subgrp</span> <span class="o">+</span> <span class="s1">&#39;:::&#39;</span> <span class="o">+</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                    <span class="n">is_filtered</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">obs_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">base_lens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rsqgl_res</span><span class="o">.</span><span class="n">segs</span><span class="p">)</span>
                    <span class="n">is_filtered</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">base_lens</span><span class="p">,</span> <span class="n">pctl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh</span>
                                      <span class="k">for</span> <span class="n">pctl</span><span class="p">,</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="n">obs_filter</span><span class="p">)</span>
                    <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                        <span class="s1">&#39;Read filtered by observation per base &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;thresholds (revert with `tombo filter clear_filters`)&#39;</span><span class="p">,</span>
                        <span class="n">bc_subgrp</span> <span class="o">+</span> <span class="s1">&#39;:::&#39;</span> <span class="o">+</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                <span class="c1"># prep and load data into index queue</span>
                <span class="n">mapped_end</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">genome_loc</span><span class="o">.</span><span class="n">Start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">rsqgl_res</span><span class="o">.</span><span class="n">segs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">index_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                    <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">genome_loc</span><span class="o">.</span><span class="n">Chrom</span><span class="p">,</span>
                    <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">genome_loc</span><span class="o">.</span><span class="n">Strand</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">readData</span><span class="p">(</span>
                        <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">genome_loc</span><span class="o">.</span><span class="n">Start</span><span class="p">,</span> <span class="n">mapped_end</span><span class="p">,</span> <span class="n">is_filtered</span><span class="p">,</span>
                        <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">read_start_rel_to_raw</span><span class="p">,</span>
                        <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">genome_loc</span><span class="o">.</span><span class="n">Strand</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">,</span>
                        <span class="n">corr_grp</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">bc_subgrp</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">rev_sig</span><span class="p">,</span>
                        <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">sig_match_score</span><span class="p">,</span> <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">mean_q_score</span><span class="p">,</span>
                        <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">align_info</span><span class="o">.</span><span class="n">ID</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">write_error_status</span><span class="p">(</span>
                    <span class="n">fast5_fn</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrp</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">bc_subgrp</span> <span class="o">+</span> <span class="s1">&#39;:::&#39;</span> <span class="o">+</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="n">_BROKEN_PIPE_ERR</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># is_tombo_error = False</span>
            <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">bc_subgrp</span> <span class="o">+</span> <span class="s1">&#39;:::&#39;</span> <span class="o">+</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

    <span class="k">return</span>


<span class="c1">#########################################</span>
<span class="c1">########## Re-squiggle Workers ##########</span>
<span class="c1">#########################################</span>

<span class="k">def</span> <span class="nf">_resquiggle_worker</span><span class="p">(</span>
        <span class="n">rsqgl_conns</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">save_params</span><span class="p">,</span> <span class="n">const_scale</span><span class="p">,</span> <span class="n">skip_seq_scaling</span><span class="p">,</span>
        <span class="n">max_scaling_iters</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run_rsqgl_iters</span><span class="p">(</span><span class="n">map_res</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="p">):</span>
        <span class="n">rsqgl_res</span> <span class="o">=</span> <span class="n">resquiggle_read</span><span class="p">(</span>
            <span class="n">map_res</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span>
            <span class="n">const_scale</span><span class="o">=</span><span class="n">const_scale</span><span class="p">,</span> <span class="n">skip_seq_scaling</span><span class="o">=</span><span class="n">skip_seq_scaling</span><span class="p">,</span>
            <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">)</span>
        <span class="n">n_iters</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">n_iters</span> <span class="o">&lt;</span> <span class="n">max_scaling_iters</span> <span class="ow">and</span> <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">norm_params_changed</span><span class="p">:</span>
            <span class="n">rsqgl_res</span> <span class="o">=</span> <span class="n">resquiggle_read</span><span class="p">(</span>
                <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">scale_values</span><span class="o">=</span><span class="n">rsqgl_res</span><span class="o">.</span><span class="n">scale_values</span><span class="p">),</span>
                <span class="n">std_ref</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="o">=</span><span class="n">all_raw_signal</span><span class="p">,</span>
                <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">)</span>
            <span class="n">n_iters</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">rsqgl_res</span>

    <span class="k">def</span> <span class="nf">adjust_map_res</span><span class="p">(</span><span class="n">map_res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">RNA_SAMP_TYPE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TRIM_RNA_ADAPTER</span><span class="p">:</span>
                <span class="c1"># trim DNA adapter off of RNA signal</span>
                <span class="n">adapter_end</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">trim_rna</span><span class="p">(</span><span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">)</span>
                <span class="c1"># trim off adapter</span>
                <span class="n">map_res</span> <span class="o">=</span> <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">raw_signal</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">[</span><span class="n">adapter_end</span><span class="p">:])</span>

            <span class="c1"># flip raw signal for re-squiggling</span>
            <span class="n">map_res</span> <span class="o">=</span> <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">raw_signal</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DNA_SAMP_TYPE</span> <span class="ow">and</span> <span class="n">USE_START_CLIP_BASES</span><span class="p">:</span>
            <span class="c1"># flip raw signal, genome and start clip seqs for re-squiggling</span>
            <span class="n">map_res</span> <span class="o">=</span> <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">raw_signal</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">genome_seq</span><span class="o">=</span><span class="n">map_res</span><span class="o">.</span><span class="n">genome_seq</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">COLLAPSE_RNA_STALLS</span> <span class="ow">and</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">RNA_SAMP_TYPE</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">COLLAPSE_DNA_STALLS</span> <span class="ow">and</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DNA_SAMP_TYPE</span><span class="p">)):</span>
            <span class="n">map_res</span> <span class="o">=</span> <span class="n">map_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">stall_ints</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">identify_stalls</span><span class="p">(</span>
                    <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">DEFAULT_STALL_PARAMS</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">map_res</span>

    <span class="k">def</span> <span class="nf">adjust_rsqgl_res</span><span class="p">(</span><span class="n">rsqgl_res</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DNA_SAMP_TYPE</span> <span class="ow">and</span> <span class="n">USE_START_CLIP_BASES</span><span class="p">:</span>
            <span class="c1"># flip raw signal and events back for storage in genome direction</span>
            <span class="n">rev_rsrtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                         <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">read_start_rel_to_raw</span> <span class="o">-</span>
                         <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rev_segs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">rsqgl_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">segs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rsqgl_res</span> <span class="o">=</span> <span class="n">rsqgl_res</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">read_start_rel_to_raw</span><span class="o">=</span><span class="n">rev_rsrtr</span><span class="p">,</span> <span class="n">segs</span><span class="o">=</span><span class="n">rev_segs</span><span class="p">,</span>
                <span class="n">genome_seq</span><span class="o">=</span><span class="n">rsqgl_res</span><span class="o">.</span><span class="n">genome_seq</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">raw_signal</span><span class="o">=</span><span class="n">rsqgl_res</span><span class="o">.</span><span class="n">raw_signal</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">rsqgl_res</span>


    <span class="k">if</span> <span class="n">_DEBUG_PLOTTING</span><span class="p">:</span>
        <span class="n">_open_debug_pdf</span><span class="p">()</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">rsqgl_conns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># get next active connection or wait for one to be ready</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn_num</span><span class="p">,</span> <span class="n">rsqgl_conn</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span><span class="n">conn_num</span><span class="p">,</span> <span class="n">rsqgl_conn</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">conn_num</span><span class="p">,</span> <span class="n">rsqgl_conn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rsqgl_conns</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rsqgl_conn</span><span class="o">.</span><span class="n">poll</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># if re-squiggle process/connection dies unexpectedly</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">map_info</span> <span class="o">=</span> <span class="n">rsqgl_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="n">map_info</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">map_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># this thread has finished the reads queue</span>
                <span class="c1"># (or died unexpectedly)</span>
                <span class="k">del</span> <span class="n">rsqgl_conns</span><span class="p">[</span><span class="n">conn_num</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="n">map_res</span><span class="p">,</span> <span class="n">fast5_fn</span> <span class="o">=</span> <span class="n">map_info</span>

            <span class="n">map_res</span> <span class="o">=</span> <span class="n">adjust_map_res</span><span class="p">(</span><span class="n">map_res</span><span class="p">)</span>
            <span class="c1"># save un-normalized signal for later iterations</span>
            <span class="n">all_raw_signal</span> <span class="o">=</span> <span class="n">map_res</span><span class="o">.</span><span class="n">raw_signal</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rsqgl_res</span> <span class="o">=</span> <span class="n">run_rsqgl_iters</span><span class="p">(</span>
                    <span class="n">map_res</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">MemoryError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                    <span class="s1">&#39;Memory error consider setting --max-signal-length or &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;--max-sequence-length&#39;</span><span class="p">)</span>
            <span class="c1"># if the resquiggle read fails for any reason</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">rsqgl_res</span> <span class="o">=</span> <span class="n">run_rsqgl_iters</span><span class="p">(</span>
                    <span class="n">map_res</span><span class="p">,</span> <span class="n">save_params</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="p">)</span>
            <span class="n">rsqgl_res</span> <span class="o">=</span> <span class="n">adjust_rsqgl_res</span><span class="p">(</span><span class="n">rsqgl_res</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rsqgl_conn</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">]])</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rsqgl_conn</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">]])</span>
            <span class="k">continue</span>

        <span class="n">rsqgl_conn</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="n">rsqgl_res</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">_DEBUG_PLOTTING</span><span class="p">:</span>
        <span class="n">_close_debug_pdf</span><span class="p">()</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">_PROFILE_RSQGL</span><span class="p">:</span>
    <span class="n">_resquiggle_wrapper</span> <span class="o">=</span> <span class="n">_resquiggle_worker</span>
    <span class="k">def</span> <span class="nf">_resquiggle_worker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_resquiggle_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;resquiggle_main.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">_io_and_mappy_thread_worker</span><span class="p">(</span>
        <span class="n">fast5_q</span><span class="p">,</span> <span class="n">progress_q</span><span class="p">,</span> <span class="n">failed_reads_q</span><span class="p">,</span> <span class="n">index_q</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span>
        <span class="n">corr_grp</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">compute_sd</span><span class="p">,</span> <span class="n">sig_match_thresh</span><span class="p">,</span>
        <span class="n">obs_filter</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">map_conn</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">sig_len_rng</span><span class="p">,</span> <span class="n">seq_len_rng</span><span class="p">):</span>
    <span class="c1"># increase update interval as more reads are provided</span>
    <span class="n">proc_update_interval</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="n">num_processed</span><span class="p">,</span> <span class="n">proc_update_interval</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num_processed</span> <span class="o">%</span> <span class="n">proc_update_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">proc_update_interval</span><span class="p">)</span>
            <span class="c1"># increase update interval as more reads are processed</span>
            <span class="k">if</span> <span class="n">num_processed</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">proc_update_interval</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="n">num_processed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">proc_update_interval</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">proc_update_interval</span>

    <span class="c1"># get mappy aligner thread buffer</span>
    <span class="n">map_thr_buf</span> <span class="o">=</span> <span class="n">mappy</span><span class="o">.</span><span class="n">ThreadBuffer</span><span class="p">()</span>

    <span class="n">num_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fast5_fn</span> <span class="o">=</span> <span class="n">fast5_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">fast5_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># signal that all reads have been processed to child process</span>
                <span class="n">map_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BrokenPipeError</span><span class="p">:</span>
                <span class="c1"># ignore if the re-squiggle process was killed during run</span>
                <span class="k">pass</span>
            <span class="c1"># update with all reads processed from this thread</span>
            <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">num_processed</span> <span class="o">%</span> <span class="n">proc_update_interval</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">num_processed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">_DRY_RUN</span><span class="p">:</span>
            <span class="n">prep_result</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fast5_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># prep the fast5 file for writing</span>
            <span class="n">prep_result</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">prep_fast5</span><span class="p">(</span>
                <span class="n">fast5_fn</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span> <span class="n">return_fp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prep_result</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
            <span class="n">fast5_data</span> <span class="o">=</span> <span class="n">prep_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">prep_result</span><span class="p">)</span>
            <span class="n">proc_update_interval</span> <span class="o">=</span> <span class="n">update_progress</span><span class="p">(</span>
                <span class="n">num_processed</span><span class="p">,</span> <span class="n">proc_update_interval</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_io_and_map_read</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="n">failed_reads_q</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span>
                <span class="n">aligner</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">map_thr_buf</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">,</span>
                <span class="n">num_processed</span><span class="p">,</span> <span class="n">map_conn</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">compute_sd</span><span class="p">,</span>
                <span class="n">obs_filter</span><span class="p">,</span> <span class="n">index_q</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="p">,</span> <span class="n">sig_match_thresh</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
                <span class="n">sig_len_rng</span><span class="p">,</span> <span class="n">seq_len_rng</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># if re-squiggle connection is dead then this thread can no longer</span>
            <span class="c1"># successfully process reads</span>
            <span class="k">if</span> <span class="n">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="n">_BROKEN_PIPE_ERR</span><span class="p">:</span>
                <span class="c1"># update with all reads processed from this thread</span>
                <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">num_processed</span> <span class="o">%</span> <span class="n">proc_update_interval</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fast5_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s1">&#39;Error closing fast5 file&#39;</span><span class="p">,</span> <span class="n">fast5_fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">proc_update_interval</span> <span class="o">=</span> <span class="n">update_progress</span><span class="p">(</span>
            <span class="n">num_processed</span><span class="p">,</span> <span class="n">proc_update_interval</span><span class="p">)</span>

    <span class="k">return</span>


<span class="c1">############################################</span>
<span class="c1">########## Multi-process Handling ##########</span>
<span class="c1">############################################</span>

<span class="k">def</span> <span class="nf">_get_progress_fail_queues</span><span class="p">(</span>
        <span class="n">progress_q</span><span class="p">,</span> <span class="n">failed_reads_q</span><span class="p">,</span> <span class="n">pf_conn</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">,</span> <span class="n">failed_reads_fn</span><span class="p">,</span>
        <span class="n">num_update_errors</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">format_fail_summ</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fail_summ</span><span class="o">=</span><span class="p">[],</span> <span class="n">num_proc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_errs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">summ_errs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fail_summ</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">num_errs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">summ_errs</span> <span class="o">=</span> <span class="n">summ_errs</span><span class="p">[:</span><span class="n">num_errs</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">summ_errs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_errs</span><span class="p">:</span>
                <span class="n">summ_errs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                    <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_errs</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">summ_errs</span><span class="p">))])</span>
        <span class="n">errs_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{:8.1f}</span><span class="s2">% (</span><span class="si">{:&gt;7}</span><span class="s2"> reads)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">n_fns</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_proc</span><span class="p">),</span>
                                            <span class="n">n_fns</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:&lt;80}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">err</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n_fns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_proc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span>
            <span class="s1">&#39;     -----&#39;</span> <span class="k">for</span> <span class="n">n_fns</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">summ_errs</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="n">errs_str</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
            <span class="s1">&#39;Re-squiggling reads (raw signal to genomic sequence alignment).&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_update_errors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># add lines for dynamic error messages</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_update_errors</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]))</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_reads</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_update_errors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prog_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">_term_move_up</span><span class="p">(),]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_update_errors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span>
            <span class="n">bar_update_header</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">num_update_errors</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; most common unsuccessful &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;read types (approx. %):&#39;</span><span class="p">)</span>
            <span class="c1"># write failed read update header</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prog_prefix</span> <span class="o">+</span> <span class="n">format_fail_summ</span><span class="p">(</span>
                <span class="n">bar_update_header</span><span class="p">,</span> <span class="n">num_errs</span><span class="o">=</span><span class="n">num_update_errors</span><span class="p">),</span>
                      <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="n">tot_num_rec_proc</span><span class="p">,</span> <span class="n">last_prog_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">non_tombo_errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_reads</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># continue to process the failed reads queue until the end signal</span>
    <span class="c1"># is sent via the failed_read_conn</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tot_num_rec_proc</span> <span class="o">+=</span> <span class="n">progress_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># only update once the progress queue has emptied to make fewer</span>
            <span class="c1"># updates to the bar (can be annoying for cat&#39;ing stderr)</span>
            <span class="k">if</span> <span class="n">VERBOSE</span> <span class="ow">and</span> <span class="n">tot_num_rec_proc</span> <span class="o">&gt;</span> <span class="n">last_prog_update</span><span class="p">:</span>
                <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tot_num_rec_proc</span> <span class="o">-</span> <span class="n">last_prog_update</span><span class="p">)</span>
                <span class="n">last_prog_update</span> <span class="o">=</span> <span class="n">tot_num_rec_proc</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">errorType</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">is_tombo_error</span> <span class="o">=</span> <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_tombo_error</span><span class="p">:</span>
                    <span class="n">failed_reads</span><span class="p">[</span><span class="n">errorType</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">failed_reads</span><span class="p">[</span><span class="s1">&#39;Unexpected error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_tombo_errors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_MAX_NUM_UNEXP_ERRORS</span><span class="p">:</span>
                        <span class="n">non_tombo_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">:::</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">errorType</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="c1"># check if all reads are done signal was sent from main thread</span>
                <span class="k">if</span> <span class="n">pf_conn</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">VERBOSE</span> <span class="ow">and</span> <span class="n">num_update_errors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prog_prefix</span> <span class="o">+</span> <span class="n">format_fail_summ</span><span class="p">(</span>
                        <span class="n">bar_update_header</span><span class="p">,</span>
                        <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">err</span><span class="p">,</span> <span class="n">fns</span> <span class="ow">in</span> <span class="n">failed_reads</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
                        <span class="n">tot_num_rec_proc</span><span class="p">,</span> <span class="n">num_update_errors</span><span class="p">),</span>
                              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="c1"># empty any entries left in queues after processes have finished</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">progress_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">tot_num_rec_proc</span> <span class="o">+=</span> <span class="n">progress_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span> <span class="ow">and</span> <span class="n">tot_num_rec_proc</span> <span class="o">&gt;</span> <span class="n">last_prog_update</span><span class="p">:</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tot_num_rec_proc</span> <span class="o">-</span> <span class="n">last_prog_update</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">errorType</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">is_tombo_error</span> <span class="o">=</span> <span class="n">failed_reads_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_tombo_error</span><span class="p">:</span>
            <span class="n">failed_reads</span><span class="p">[</span><span class="n">errorType</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_tombo_errors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_MAX_NUM_UNEXP_ERRORS</span><span class="p">:</span>
                <span class="n">non_tombo_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">:::</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">errorType</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># close out failed read printout</span>
    <span class="n">fail_summary</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">err</span><span class="p">,</span> <span class="n">fns</span> <span class="ow">in</span> <span class="n">failed_reads</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_tombo_errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># add random value to filename in case multiple runs are made</span>
            <span class="c1"># from the same location</span>
            <span class="n">unex_err_fn</span> <span class="o">=</span> <span class="n">_UNEXPECTED_ERROR_FN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Unexpected errors occured. See full error stack traces &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;for first (up to) </span><span class="si">{0:d}</span><span class="s1"> errors in &quot;</span><span class="si">{1}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_MAX_NUM_UNEXP_ERRORS</span><span class="p">,</span> <span class="n">unex_err_fn</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">unex_err_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">non_tombo_errors</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail_summary</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_num_failed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fail_summary</span><span class="p">))</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Final unsuccessful reads summary &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;(</span><span class="si">{:.1%}</span><span class="s1"> reads unsuccessfully processed; </span><span class="si">{}</span><span class="s1"> total reads):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">total_num_failed</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_reads</span><span class="p">,</span> <span class="n">total_num_failed</span><span class="p">))</span>
            <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="n">format_fail_summ</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fail_summary</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;All reads successfully re-squiggled!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">failed_reads_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">failed_reads_fn</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
                <span class="n">err</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">err</span><span class="p">,</span> <span class="n">fns</span> <span class="ow">in</span> <span class="n">failed_reads</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">pf_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tot_num_rec_proc</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_get_index_queue</span><span class="p">(</span><span class="n">index_q</span><span class="p">,</span> <span class="n">index_conn</span><span class="p">,</span> <span class="n">fast5s_dir</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">):</span>
    <span class="c1"># open TomboReads object for storing and eventually writing the index data</span>
    <span class="n">reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">([</span><span class="n">fast5s_dir</span><span class="p">,],</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">for_writing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># continue to process the index queue until the end signal</span>
    <span class="c1"># is sent via the index_conn</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reads_index</span><span class="o">.</span><span class="n">add_read_data</span><span class="p">(</span><span class="o">*</span><span class="n">index_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index_conn</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="c1"># empty any entries left in queue after processes have finished</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">index_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">reads_index</span><span class="o">.</span><span class="n">add_read_data</span><span class="p">(</span><span class="o">*</span><span class="n">index_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># write index out to file</span>
    <span class="n">reads_index</span><span class="o">.</span><span class="n">write_index_file</span><span class="p">()</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_fill_files_queue</span><span class="p">(</span><span class="n">fast5_q</span><span class="p">,</span> <span class="n">fast5_fns</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fast5_fn</span> <span class="ow">in</span> <span class="n">fast5_fns</span><span class="p">:</span>
        <span class="n">fast5_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">fast5_fn</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_threads</span><span class="p">):</span>
        <span class="n">fast5_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">resquiggle_all_reads</span><span class="p">(</span>
        <span class="n">fast5_fns</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">num_ps</span><span class="p">,</span> <span class="n">threads_per_proc</span><span class="p">,</span>
        <span class="n">compute_sd</span><span class="p">,</span> <span class="n">skip_index</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">save_params</span><span class="p">,</span> <span class="n">sig_match_thresh</span><span class="p">,</span>
        <span class="n">obs_filter</span><span class="p">,</span> <span class="n">const_scale</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="p">,</span> <span class="n">skip_seq_scaling</span><span class="p">,</span>
        <span class="n">max_scaling_iters</span><span class="p">,</span> <span class="n">failed_reads_fn</span><span class="p">,</span> <span class="n">fast5s_basedir</span><span class="p">,</span> <span class="n">num_update_errors</span><span class="p">,</span>
        <span class="n">sig_len_rng</span><span class="p">,</span> <span class="n">seq_len_rng</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform genomic alignment and re-squiggle algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fast5_q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">_MAX_QUEUE_SIZE</span><span class="p">)</span>
    <span class="n">failed_reads_q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">index_q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">_MAX_QUEUE_SIZE</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_index</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">progress_q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="c1"># open all multiprocessing pipes and queues before threading</span>
    <span class="c1"># as opening threads before all process are open seems to cause</span>
    <span class="c1"># a deadlock when some processes are started.</span>
    <span class="c1"># starting all multiprocess objects seems to fix this.</span>
    <span class="n">files_p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_fill_files_queue</span><span class="p">,</span>
                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">fast5_q</span><span class="p">,</span> <span class="n">fast5_fns</span><span class="p">,</span> <span class="n">num_ps</span> <span class="o">*</span> <span class="n">threads_per_proc</span><span class="p">))</span>
    <span class="n">files_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">files_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">map_conns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rsqgl_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_ps</span><span class="p">):</span>
        <span class="n">proc_rsqgl_conns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads_per_proc</span><span class="p">):</span>
            <span class="c1"># open mp pipe to communicate with re-squiggle process</span>
            <span class="n">map_conn</span><span class="p">,</span> <span class="n">rsqgl_conn</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
            <span class="n">map_conns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_conn</span><span class="p">)</span>
            <span class="n">proc_rsqgl_conns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rsqgl_conn</span><span class="p">)</span>
        <span class="c1"># open re-squiggle process to void intensive processing hitting the GIL</span>
        <span class="n">rsqgl_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">proc_rsqgl_conns</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">save_params</span><span class="p">,</span> <span class="n">const_scale</span><span class="p">,</span> <span class="n">skip_seq_scaling</span><span class="p">,</span>
            <span class="n">max_scaling_iters</span><span class="p">)</span>
        <span class="n">rsqgl_process</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_resquiggle_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">rsqgl_args</span><span class="p">)</span>
        <span class="n">rsqgl_process</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">rsqgl_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">rsqgl_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rsqgl_process</span><span class="p">)</span>

    <span class="c1"># failed read and progress queues getter</span>
    <span class="n">main_pf_conn</span><span class="p">,</span> <span class="n">pf_conn</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
    <span class="n">pf_p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_get_progress_fail_queues</span><span class="p">,</span>
                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">progress_q</span><span class="p">,</span> <span class="n">failed_reads_q</span><span class="p">,</span> <span class="n">pf_conn</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">),</span>
                            <span class="n">failed_reads_fn</span><span class="p">,</span> <span class="n">num_update_errors</span><span class="p">))</span>
    <span class="n">pf_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pf_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># index queue getter</span>
    <span class="k">if</span> <span class="n">index_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_index_conn</span><span class="p">,</span> <span class="n">index_conn</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
        <span class="n">index_p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_get_index_queue</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
            <span class="n">index_q</span><span class="p">,</span> <span class="n">index_conn</span><span class="p">,</span> <span class="n">fast5s_basedir</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">))</span>
        <span class="n">index_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">index_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># now open mapping thread for each map connection created above</span>
    <span class="n">map_and_io_ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">map_conn</span> <span class="ow">in</span> <span class="n">map_conns</span><span class="p">:</span>
        <span class="n">map_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">fast5_q</span><span class="p">,</span> <span class="n">progress_q</span><span class="p">,</span> <span class="n">failed_reads_q</span><span class="p">,</span> <span class="n">index_q</span><span class="p">,</span> <span class="n">bc_grp</span><span class="p">,</span>
                    <span class="n">bc_subgrps</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span> <span class="n">compute_sd</span><span class="p">,</span>
                    <span class="n">sig_match_thresh</span><span class="p">,</span> <span class="n">obs_filter</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span>
                    <span class="n">map_conn</span><span class="p">,</span> <span class="n">q_score_thresh</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">sig_len_rng</span><span class="p">,</span> <span class="n">seq_len_rng</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_io_and_mappy_thread_worker</span><span class="p">,</span>
                             <span class="n">args</span><span class="o">=</span><span class="n">map_args</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">map_and_io_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># wait for all mapping and re-squiggling workers to finish</span>
    <span class="n">files_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">map_and_io_ts</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rsqgl_p</span> <span class="ow">in</span> <span class="n">rsqgl_ps</span><span class="p">:</span>
        <span class="n">rsqgl_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># in a very unlikely case the progress/fail queue could die while the</span>
    <span class="c1"># main process remains active and thus we would have a deadlock here</span>
    <span class="k">if</span> <span class="n">pf_p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="c1"># send signal to getter queue to finish and return results</span>
        <span class="n">main_pf_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># returns total number of processed reads if that is needed</span>
        <span class="n">main_pf_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">pf_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">index_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_index_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">index_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">return</span>


<span class="c1">###################################</span>
<span class="c1">########## Main Function ##########</span>
<span class="c1">###################################</span>

<span class="k">def</span> <span class="nf">_parse_files_and_lock_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Getting file list.&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Provided [fast5-basedir] is not a directory.&#39;</span><span class="p">)</span>
        <span class="n">fast5s_basedir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">else</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="n">files</span><span class="p">,</span> <span class="n">lock_fns</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_files_list_and_lock_dirs</span><span class="p">(</span>
            <span class="n">fast5s_basedir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore_read_locks</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Reads base directory or a sub-directory does not appear to be &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;accessible. Check directory permissions.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">clear_tombo_locks</span><span class="p">(</span><span class="n">lock_fns</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No files identified in the specified &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;directory or within immediate subdirectories.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">th</span><span class="o">.</span><span class="n">reads_contain_basecalls</span><span class="p">(</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_group</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">th</span><span class="o">.</span><span class="n">clear_tombo_locks</span><span class="p">(</span><span class="n">lock_fns</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Reads do not to contain basecalls. Check --basecall-group &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;option if basecalls are stored in non-standard location or &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;use `tombo preprocess annotate_raw_with_fastqs` to add &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;basecalls from FASTQ files to raw FAST5 files.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">fast5s_basedir</span><span class="p">,</span> <span class="n">lock_fns</span>

<span class="k">def</span> <span class="nf">_resquiggle_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main method for resquiggle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">_DEBUG_PLOTTING</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Cannot run multiple processes and debugging.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_DEBUG_PLOTTING</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Producing de-bug plotting output. Can be very slow and should &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;only be run on a small number of files.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_DRY_RUN</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Producing de-bug output. Not saving re-squiggle results.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_DEBUG_BANDWIDTH</span> <span class="ow">or</span> <span class="n">_DEBUG_START_BANDWIDTH</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;bandwidth</span><span class="se">\t</span><span class="s1">min_bw_edge_buffer</span><span class="se">\t</span><span class="s1">mean_dp_score</span><span class="se">\t</span><span class="s1">read_id</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print_advanced_arguments</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_option_parsers</span>
        <span class="n">_option_parsers</span><span class="o">.</span><span class="n">print_advanced_resquiggle</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_group</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;--basecall-group and --corrected-group must &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;be different.&#39;</span><span class="p">)</span>

    <span class="c1"># check simple arguments for validity first</span>
    <span class="n">outlier_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">outlier_threshold</span>
    <span class="k">if</span> <span class="n">outlier_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">outlier_thresh</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outlier_thresh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">obs_filter</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_obs_filter</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">obs_per_base_filter</span><span class="p">)</span> \
                 <span class="k">if</span> <span class="s1">&#39;obs_per_base_filter&#39;</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Loading minimap2 reference.&#39;</span><span class="p">)</span>
    <span class="c1"># to be enabled when mappy genome sequence extraction bug is fixed</span>
    <span class="n">aligner</span> <span class="o">=</span> <span class="n">mappy</span><span class="o">.</span><span class="n">Aligner</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">reference</span><span class="p">),</span> <span class="n">preset</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;map-ont&#39;</span><span class="p">),</span> <span class="n">best_n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">aligner</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Failed to load reference genome FASTA for mapping.&#39;</span><span class="p">)</span>

    <span class="c1"># get files as late as possible in startup since it takes the longest</span>
    <span class="c1"># and so other errors can&#39;t happen after locks are written</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">fast5s_basedir</span><span class="p">,</span> <span class="n">lock_fns</span> <span class="o">=</span> <span class="n">_parse_files_and_lock_dirs</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seq_sample_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">RNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> \
                            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seq_sample_type</span> <span class="o">==</span> <span class="n">RNA_SAMP_TYPE</span> <span class="k">else</span> \
                               <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_sample_type</span><span class="p">(</span><span class="n">fast5_fns</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="c1"># parse tombo model</span>
        <span class="n">std_ref</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">TomboModel</span><span class="p">(</span>
            <span class="n">ref_fn</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">,</span>
            <span class="n">fast5_fns</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">seq_samp_type</span>
        <span class="k">if</span> <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DNA_SAMP_TYPE</span> <span class="ow">and</span> <span class="n">USE_START_CLIP_BASES</span><span class="p">:</span>
            <span class="n">std_ref</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">reverse_sequence_copy</span><span class="p">()</span>

        <span class="n">sig_match_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">signal_matching_score</span>
        <span class="k">if</span> <span class="n">sig_match_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig_match_thresh</span> <span class="o">=</span> <span class="n">SIG_MATCH_THRESH</span><span class="p">[</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">const_scale</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fixed_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">const_scale</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fixed_scale</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">fit_global_scale</span><span class="p">:</span>
            <span class="n">const_scale</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">estimate_global_scale</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="n">rsqgl_params</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">load_resquiggle_parameters</span><span class="p">(</span>
            <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">signal_align_parameters</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">segmentation_parameters</span><span class="p">)</span>
        <span class="n">save_params</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">load_resquiggle_parameters</span><span class="p">(</span>
            <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">signal_align_parameters</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">segmentation_parameters</span><span class="p">,</span> <span class="n">use_save_bandwidth</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">resquiggle_all_reads</span><span class="p">(</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threads_per_process</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">include_event_stdev</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_index</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">save_params</span><span class="p">,</span> <span class="n">sig_match_thresh</span><span class="p">,</span>
            <span class="n">obs_filter</span><span class="p">,</span> <span class="n">const_scale</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">q_score</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">skip_sequence_rescaling</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">max_scaling_iterations</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">failed_reads_filename</span><span class="p">,</span> <span class="n">fast5s_basedir</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">num_most_common_errors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">signal_length_range</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">sequence_length_range</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">clear_tombo_locks</span><span class="p">(</span><span class="n">lock_fns</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;This is a module. See commands with `tombo -h`&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-18, Oxford Nanopore Technologies

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>